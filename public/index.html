<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>IQAI ‚Äî AI Vigilance Assessment</title>
<link rel="icon" href="data:,">

<link href="https://fonts.googleapis.com/css2?family=DM+Mono:wght@400;500&family=DM+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">

<script src="https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js" defer></script>
<script>
  window.OneSignalDeferred = window.OneSignalDeferred || [];
  OneSignalDeferred.push(async function(OneSignal) {
    await OneSignal.init({
      appId: "dc73bf96-dbcf-4498-ab4d-5639c66b16ea",
      safari_web_id: "web.onesignal.auto.10309993-875c-4384-934c-26792f444f2b",
      notifyButton: { enable: true },
      allowLocalhostAsSecureOrigin: true,
    });
  });
</script>

<style>
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

  :root {
    --font-display: 'DM Mono', monospace;
    --font-body: 'DM Sans', sans-serif;

    --bg: #0c0e12;
    --surface: #13161d;
    --surface-2: #1a1e28;
    --border: rgba(255,255,255,0.07);
    --border-active: rgba(255,255,255,0.18);

    --text-primary: #f0f2f7;
    --text-secondary: #8891a8;
    --text-muted: #4f566b;

    --accent: #e8ff47;
    --accent-dim: rgba(232,255,71,0.10);
    --accent-border: rgba(232,255,71,0.28);

    --danger: #ff4d6d;
    --danger-dim: rgba(255,77,109,0.10);
    --danger-border: rgba(255,77,109,0.28);

    --success: #34d399;
    --success-dim: rgba(52,211,153,0.10);
    --success-border: rgba(52,211,153,0.28);

    --radius: 12px;
    --radius-lg: 18px;
  }

  html, body {
    min-height: 100vh;
    background: var(--bg);
    font-family: var(--font-body);
    color: var(--text-primary);
  }

  body {
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 32px 16px 64px;
    background-image:
      radial-gradient(ellipse 60% 40% at 50% -10%, rgba(232,255,71,0.06) 0%, transparent 70%),
      radial-gradient(ellipse 40% 30% at 80% 80%, rgba(100,120,255,0.04) 0%, transparent 60%);
  }

  /* ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ */
  .site-header {
    width: 100%;
    max-width: 560px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 28px;
    padding-bottom: 18px;
    border-bottom: 1px solid var(--border);
  }

  .logo-block {
    display: flex;
    align-items: baseline;
    gap: 10px;
  }

  .logo-name {
    font-family: var(--font-display);
    font-size: 1em;
    font-weight: 500;
    color: var(--text-primary);
    letter-spacing: 0.06em;
  }

  .logo-tag {
    font-family: var(--font-display);
    font-size: 0.62em;
    color: var(--accent);
    border: 1px solid var(--accent-border);
    padding: 2px 7px;
    border-radius: 4px;
    letter-spacing: 0.08em;
  }

  .header-label {
    font-size: 0.72em;
    color: var(--text-muted);
    font-family: var(--font-display);
    letter-spacing: 0.06em;
  }

  /* ‚îÄ‚îÄ CARD ‚îÄ‚îÄ */
  .container {
    max-width: 560px;
    width: 100%;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius-lg);
    padding: 28px;
    position: relative;
    overflow: hidden;
  }

  .container::before {
    content: '';
    position: absolute;
    top: 0; left: 0; right: 0;
    height: 1px;
    background: linear-gradient(90deg, transparent, rgba(232,255,71,0.25), transparent);
  }

  /* ‚îÄ‚îÄ START SCREEN ‚îÄ‚îÄ */
  .start-eyebrow {
    font-family: var(--font-display);
    font-size: 0.68em;
    color: var(--accent);
    letter-spacing: 0.12em;
    margin-bottom: 12px;
    text-transform: uppercase;
  }

  .start-title {
    font-size: 1.65em;
    font-weight: 800;
    line-height: 1.2;
    color: var(--text-primary);
    margin-bottom: 10px;
  }

  .start-title em {
    font-style: normal;
    color: var(--accent);
  }

  .start-desc {
    font-size: 0.92em;
    color: var(--text-secondary);
    line-height: 1.65;
    margin-bottom: 26px;
  }

  .rules-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 10px;
    margin-bottom: 26px;
  }

  .rule-item {
    background: var(--surface-2);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 12px 14px;
    font-size: 0.83em;
    line-height: 1.4;
    color: var(--text-secondary);
  }

  .rule-item strong {
    display: block;
    color: var(--text-primary);
    margin-bottom: 3px;
    font-size: 0.92em;
  }

  .rule-icon {
    display: block;
    font-size: 1.2em;
    margin-bottom: 6px;
  }

  #startBtn {
    width: 100%;
    padding: 15px;
    background: var(--accent);
    color: #0c0e12;
    border: none;
    border-radius: var(--radius);
    font-family: var(--font-display);
    font-size: 0.85em;
    font-weight: 500;
    letter-spacing: 0.08em;
    cursor: pointer;
    transition: all 0.15s;
    text-transform: uppercase;
  }
  #startBtn:hover {
    background: #d4eb30;
    transform: translateY(-1px);
    box-shadow: 0 8px 24px rgba(232,255,71,0.18);
  }
  #startBtn:active { transform: translateY(0); }

  /* ‚îÄ‚îÄ TIMER / PROGRESS ‚îÄ‚îÄ */
  #timerLine {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 14px;
  }

  .progress-label {
    font-family: var(--font-display);
    font-size: 0.68em;
    color: var(--text-muted);
    letter-spacing: 0.06em;
  }

  #timerDisplay {
    font-family: var(--font-display);
    font-size: 0.7em;
    color: var(--accent);
    background: var(--accent-dim);
    border: 1px solid var(--accent-border);
    padding: 5px 12px;
    border-radius: 999px;
    letter-spacing: 0.05em;
  }
  #timerDisplay.timer-urgent {
    background: var(--danger-dim);
    border-color: var(--danger-border);
    color: var(--danger);
  }

  .progress-bar-wrap {
    width: 100%;
    height: 2px;
    background: var(--surface-2);
    border-radius: 99px;
    margin-bottom: 22px;
    overflow: hidden;
  }
  .progress-bar-fill {
    height: 100%;
    background: var(--accent);
    border-radius: 99px;
    transition: width 0.4s ease;
  }

  /* ‚îÄ‚îÄ QUESTION ‚îÄ‚îÄ */
  .question-meta {
    font-family: var(--font-display);
    font-size: 0.63em;
    color: var(--text-muted);
    letter-spacing: 0.08em;
    margin-bottom: 8px;
    text-transform: uppercase;
  }

  .question {
    font-size: 1.02em;
    font-weight: 700;
    line-height: 1.45;
    color: var(--text-primary);
    margin-bottom: 18px;
  }

  /* ‚îÄ‚îÄ OPTIONS ‚îÄ‚îÄ */
  .options button {
    display: flex;
    align-items: center;
    gap: 12px;
    width: 100%;
    padding: 12px 15px;
    margin-bottom: 8px;
    background: var(--surface-2);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    color: var(--text-secondary);
    cursor: pointer;
    font-family: var(--font-body);
    font-size: 0.93em;
    font-weight: 500;
    text-align: left;
    transition: all 0.13s;
  }
  .options button:hover {
    border-color: var(--border-active);
    color: var(--text-primary);
    background: #1f2433;
  }
  .options button.selected {
    background: var(--accent-dim);
    border-color: var(--accent-border);
    color: var(--accent);
  }

  .option-letter {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 26px;
    height: 26px;
    min-width: 26px;
    border: 1px solid var(--border-active);
    border-radius: 6px;
    font-family: var(--font-display);
    font-size: 0.7em;
    color: var(--text-muted);
    transition: all 0.13s;
    flex-shrink: 0;
  }
  .options button.selected .option-letter {
    background: var(--accent);
    border-color: var(--accent);
    color: #0c0e12;
    font-weight: 700;
  }

  /* ‚îÄ‚îÄ BUTTONS ‚îÄ‚îÄ */
  #nextBtn {
    width: 100%;
    padding: 13px;
    margin-top: 12px;
    background: transparent;
    border: 1px solid var(--border-active);
    border-radius: var(--radius);
    color: var(--text-secondary);
    cursor: pointer;
    font-family: var(--font-display);
    font-size: 0.75em;
    letter-spacing: 0.06em;
    text-transform: uppercase;
    transition: all 0.13s;
  }
  #nextBtn:hover:not(:disabled) {
    border-color: var(--text-secondary);
    color: var(--text-primary);
  }
  #nextBtn:disabled { opacity: 0.3; cursor: not-allowed; }

  #doubtBtn {
    width: 100%;
    padding: 14px;
    margin-top: 8px;
    background: var(--danger-dim);
    border: 1px solid var(--danger-border);
    border-radius: var(--radius);
    color: var(--danger);
    cursor: pointer;
    font-family: var(--font-display);
    font-size: 0.75em;
    letter-spacing: 0.06em;
    text-transform: uppercase;
    transition: all 0.13s;
  }
  #doubtBtn:hover:not(:disabled) {
    background: rgba(255,77,109,0.18);
    border-color: var(--danger);
  }
  #doubtBtn:disabled { opacity: 0.3; cursor: not-allowed; }

  /* ‚îÄ‚îÄ RESULT ‚îÄ‚îÄ */
  #tokenContainer {
    width: 100%;
    margin-bottom: 18px;
    border-radius: var(--radius);
    overflow: hidden;
    border: 1px solid var(--border);
  }
  #tokenImage { display: block; width: 100%; height: auto; }
  #tokenCanvas { display: block; width: 100%; height: auto; }

  .score-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 10px;
    margin-bottom: 14px;
  }

  .score-card {
    background: var(--surface-2);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 14px 16px;
    text-align: center;
  }

  .sc-label {
    font-family: var(--font-display);
    font-size: 0.6em;
    color: var(--text-muted);
    letter-spacing: 0.08em;
    text-transform: uppercase;
    margin-bottom: 6px;
  }

  .sc-value {
    font-size: 1.5em;
    font-weight: 800;
    color: var(--text-primary);
  }

  .sc-value.accent { color: var(--accent); }

  .feedback {
    text-align: center;
    font-size: 0.88em;
    color: var(--text-secondary);
    font-style: italic;
    margin-bottom: 6px;
  }

  .streak {
    text-align: center;
    font-family: var(--font-display);
    font-size: 0.62em;
    color: var(--text-muted);
    letter-spacing: 0.06em;
    margin-bottom: 16px;
  }

  #restartBtn, #shareBtn {
    width: 100%;
    padding: 12px;
    margin-bottom: 8px;
    border-radius: var(--radius);
    font-family: var(--font-display);
    font-size: 0.75em;
    letter-spacing: 0.06em;
    text-transform: uppercase;
    cursor: pointer;
    transition: all 0.13s;
    border: 1px solid;
  }

  #restartBtn {
    background: transparent;
    border-color: var(--border-active);
    color: var(--text-secondary);
  }
  #restartBtn:hover { border-color: var(--text-secondary); color: var(--text-primary); }

  #shareBtn {
    background: #0077b5;
    border-color: #0077b5;
    color: #fff;
  }
  #shareBtn:hover { background: #005885; border-color: #005885; }

  /* ‚îÄ‚îÄ REVIEW ‚îÄ‚îÄ */
  #reviewContainer { margin-top: 24px; }
  #reviewContainer h3 {
    font-family: var(--font-display);
    font-size: 0.68em;
    color: var(--text-muted);
    letter-spacing: 0.1em;
    text-transform: uppercase;
    margin-bottom: 12px;
    padding-bottom: 10px;
    border-bottom: 1px solid var(--border);
  }

  .reviewItem {
    padding: 13px 15px;
    border: 1px solid var(--border);
    border-radius: var(--radius);
    margin-bottom: 8px;
    background: var(--surface-2);
    line-height: 1.45;
    font-size: 0.88em;
    color: var(--text-secondary);
  }
  .reviewItem strong { color: var(--text-primary); }

  .answerTag {
    display: inline-block;
    padding: 2px 9px;
    border-radius: 999px;
    font-family: var(--font-display);
    font-size: 0.75em;
  }
  .answerTag.ok {
    background: var(--success-dim);
    border: 1px solid var(--success-border);
    color: var(--success);
  }
  .answerTag.bad {
    background: var(--danger-dim);
    border: 1px solid var(--danger-border);
    color: var(--danger);
  }

  .haluBanner {
    margin-top: 8px;
    padding: 8px 12px;
    border-radius: 8px;
    font-weight: 600;
    font-size: 0.88em;
    line-height: 1.4;
  }
  .haluBanner.ok { background: var(--success-dim); border: 1px solid var(--success-border); color: var(--success); }
  .haluBanner.bad { background: var(--danger-dim); border: 1px solid var(--danger-border); color: var(--danger); }

  .errorBox {
    margin-top: 10px;
    padding: 12px;
    border-radius: var(--radius);
    background: var(--danger-dim);
    border: 1px solid var(--danger-border);
    color: var(--danger);
    font-size: 0.88em;
    line-height: 1.4;
  }

  /* ‚îÄ‚îÄ LEADERBOARD ‚îÄ‚îÄ */
  #rankingSection {
    margin-top: 24px;
    padding: 20px;
    background: var(--surface-2);
    border: 1px solid var(--border);
    border-radius: var(--radius-lg);
  }

  #rankingSection h3 {
    font-family: var(--font-display);
    font-size: 0.68em;
    color: var(--text-muted);
    letter-spacing: 0.1em;
    text-transform: uppercase;
    margin-bottom: 14px;
    margin-top: 0;
  }

  .leaderboard-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px 0;
    border-bottom: 1px solid var(--border);
    font-size: 0.9em;
  }

  .pseudo-area {
    margin-top: 14px;
    background: var(--surface);
    border: 1px solid var(--border);
    padding: 14px;
    border-radius: var(--radius);
  }

  .pseudo-label {
    display: block;
    font-family: var(--font-display);
    font-size: 0.62em;
    color: var(--text-muted);
    letter-spacing: 0.08em;
    text-transform: uppercase;
    margin-bottom: 10px;
  }

  .pseudo-row { display: flex; gap: 8px; }

  .pseudo-row input {
    flex: 1;
    padding: 10px 12px;
    background: var(--surface-2);
    border: 1px solid var(--border-active);
    border-radius: 8px;
    color: var(--text-primary);
    font-family: var(--font-body);
    font-size: 0.92em;
    outline: none;
    transition: border-color 0.15s;
  }
  .pseudo-row input:focus { border-color: var(--accent); }
  .pseudo-row input::placeholder { color: var(--text-muted); }

  .pseudo-row button {
    padding: 0 18px;
    background: var(--accent);
    border: none;
    border-radius: 8px;
    color: #0c0e12;
    font-family: var(--font-display);
    font-size: 0.72em;
    cursor: pointer;
    letter-spacing: 0.06em;
    text-transform: uppercase;
    transition: background 0.13s;
  }
  .pseudo-row button:hover { background: #d4eb30; }

  /* ‚îÄ‚îÄ HOW IT WORKS ‚îÄ‚îÄ */
  #howItWorks {
    margin-top: 14px;
    padding: 14px 16px;
    background: var(--surface-2);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    font-size: 0.83em;
    line-height: 1.75;
    color: var(--text-secondary);
  }

  #howItWorks strong {
    display: block;
    font-family: var(--font-display);
    font-size: 0.68em;
    letter-spacing: 0.08em;
    text-transform: uppercase;
    color: var(--text-muted);
    margin-bottom: 8px;
  }

  /* ‚îÄ‚îÄ COOLDOWN ‚îÄ‚îÄ */
  .cooldownMessage {
    text-align: center;
    padding: 32px 20px;
  }
  .cooldownMessage h2 { font-size: 1.2em; margin-bottom: 12px; color: var(--text-primary); }
  .cooldownMessage p { font-size: 0.92em; line-height: 1.6; color: var(--text-secondary); }
  .cooldownMessage button {
    margin-top: 20px;
    padding: 11px 24px;
    background: var(--surface-2);
    color: var(--text-secondary);
    border: 1px solid var(--border-active);
    border-radius: var(--radius);
    font-family: var(--font-display);
    font-size: 0.72em;
    letter-spacing: 0.06em;
    text-transform: uppercase;
    cursor: pointer;
    transition: all 0.13s;
  }
  .cooldownMessage button:hover { border-color: var(--accent); color: var(--accent); }

  /* ‚îÄ‚îÄ POPUP ‚îÄ‚îÄ */
  .notifPopup {
    position: fixed; inset: 0;
    background: rgba(0,0,0,0.75);
    display: flex; align-items: center; justify-content: center;
    z-index: 9999; padding: 20px;
    backdrop-filter: blur(4px);
  }
  .notifPopup.hidden { display: none !important; }

  .notifPopupContent {
    background: var(--surface);
    border: 1px solid var(--border-active);
    border-radius: var(--radius-lg);
    padding: 32px 28px;
    max-width: 400px; width: 100%;
    text-align: center;
    animation: popupSlide 0.3s ease;
  }
  @keyframes popupSlide {
    from { transform: translateY(-18px); opacity: 0; }
    to { transform: translateY(0); opacity: 1; }
  }
  .notifPopup h2 { font-size: 1.15em; margin-bottom: 10px; color: var(--text-primary); }
  .notifPopup p { font-size: 0.88em; line-height: 1.6; color: var(--text-secondary); margin-bottom: 22px; }

  .notifPopup .btnPrimary {
    width: 100%; padding: 13px; border: none; border-radius: var(--radius);
    background: var(--accent); color: #0c0e12;
    font-family: var(--font-display); font-size: 0.75em;
    letter-spacing: 0.06em; text-transform: uppercase;
    cursor: pointer; margin-bottom: 10px; transition: background 0.13s;
  }
  .notifPopup .btnPrimary:hover { background: #d4eb30; }
  .notifPopup .btnSecondary {
    background: none; border: none; color: var(--text-muted);
    font-size: 0.85em; cursor: pointer; padding: 8px;
    transition: color 0.13s;
  }
  .notifPopup .btnSecondary:hover { color: var(--text-secondary); }

  .hidden { display: none !important; }

  @media (max-width: 420px) {
    .rules-grid { grid-template-columns: 1fr; }
    .score-grid { grid-template-columns: 1fr; }
    body { padding: 20px 12px 48px; }
  }
</style>
</head>

<body>

  <header class="site-header">
    <div class="logo-block">
      <span class="logo-name">IQAI</span>
      <span class="logo-tag">BETA</span>
    </div>
    <span class="header-label">AI Vigilance Assessment</span>
  </header>

  <!-- START -->
  <div id="startScreen" class="container">
    <p class="start-eyebrow">Daily challenge ‚Äî 10 questions</p>
    <h2 class="start-title">√ätes-vous plus fort<br>que l'<em>hallucination</em> ?</h2>
    <p class="start-desc">Un quiz de culture g√©n√©rale g√©n√©r√© par l'IA ‚Äî avec des erreurs volontairement ins√©r√©es. Votre mission : r√©pondre juste, et d√©tecter les fausses informations avant qu'elles ne vous pi√®gent.</p>

    <div class="rules-grid">
      <div class="rule-item">
        <span class="rule-icon">‚úÖ</span>
        <strong>Bonne r√©ponse</strong>
        La question est fiable ‚Üí r√©pondez ‚Üí +1 pt
      </div>
      <div class="rule-item">
        <span class="rule-icon">‚ö†</span>
        <strong>Anomalie d√©tect√©e</strong>
        L'IA d√©raille ‚Üí signalez ‚Üí +1 pt
      </div>
      <div class="rule-item">
        <span class="rule-icon">‚è±</span>
        <strong>Rapidit√©</strong>
        30 secondes par question.
      </div>
      <div class="rule-item">
        <span class="rule-icon">üèÜ</span>
        <strong>Podium quotidien</strong>
        Soumettez votre score et montez au classement.
      </div>
    </div>

    <button id="startBtn">‚Üí Lancer l'√©valuation</button>
  </div>

  <!-- GAME -->
  <div class="container hidden" id="gameContainer">
    <div id="quiz">
      <div id="timerLine">
        <span class="progress-label" id="progressLabel">Question 1 / 10</span>
        <div id="timerDisplay" class="hidden">‚è± 30</div>
      </div>

      <div class="progress-bar-wrap">
        <div class="progress-bar-fill" id="progressFill" style="width:10%"></div>
      </div>

      <div id="questionContainer"></div>
      <div class="options" id="optionsContainer"></div>

      <button id="nextBtn" disabled>Confirmer ‚Üí</button>
      <button id="doubtBtn" class="hidden">‚ö† Signaler une anomalie IA</button>

      <div id="errorContainer" class="hidden"></div>
    </div>

    <div id="result" class="hidden">
      <div id="tokenContainer" class="hidden">
        <img id="tokenImage" class="hidden" />
        <canvas id="tokenCanvas" class="hidden" width="500" height="250"></canvas>
      </div>

      <div class="score-grid" id="scoreDetails"></div>

      <p class="feedback" id="feedbackDisplay"></p>
      <p class="streak" id="gamesPlayedDisplay"></p>

      <button id="restartBtn">‚Ü∫ Rejouer demain</button>
      <button id="shareBtn">‚Üó Partager sur LinkedIn</button>

      <div id="reviewContainer"></div>

      <div id="rankingSection">
        <h3>Podium du jour</h3>
        <div id="leaderboardList">
          <p style="font-size:0.85em; color:var(--text-muted); font-style:italic;">Chargement...</p>
        </div>
        <div id="pseudoInputArea" class="pseudo-area">
          <span class="pseudo-label">Votre pseudo pour le classement</span>
          <div class="pseudo-row">
            <input type="text" id="playerPseudo" maxlength="12" placeholder="Ex: Raph">
            <button onclick="submitScore()">OK</button>
          </div>
        </div>
      </div>

      <div id="howItWorks">
        <strong>Syst√®me de points</strong>
        ‚úÖ Bonne r√©ponse = +1 pt &nbsp;|&nbsp; ‚úÖ Anomalie d√©tect√©e = +1 pt<br>
        ‚ùå Mauvaise r√©ponse = 0 pt &nbsp;|&nbsp; ‚ùå Anomalie rat√©e = 0 pt
      </div>
    </div>
  </div>

  <audio id="bootSound" preload="auto" playsinline>
    <source src="Gameboy.mp3" type="audio/mpeg">
  </audio>

  <div id="notifPopup" class="notifPopup hidden">
    <div class="notifPopupContent">
      <h2>Ne manquez pas votre d√©fi quotidien</h2>
      <p>Recevez un rappel chaque jour pour relever votre √©valuation IQAI et progresser dans votre vigilance IA.</p>
      <button id="notifAccept" class="btnPrimary">Activer les rappels</button>
      <button id="notifDecline" class="btnSecondary">Plus tard</button>
    </div>
  </div>

<script>
  const API_URL = "https://iqai-backend.vercel.app/api/quiz";
  let questions = [], current = 0, score = 0, vigilance = 0, userAnswers = [];
  const QUESTION_TIME = 30;
  let timeLeft = QUESTION_TIME, timerId = null;

  const questionContainer = document.getElementById('questionContainer');
  const optionsContainer = document.getElementById('optionsContainer');
  const nextBtn = document.getElementById('nextBtn');
  const doubtBtn = document.getElementById('doubtBtn');
  const quizDiv = document.getElementById('quiz');
  const resultDiv = document.getElementById('result');
  const scoreDetails = document.getElementById('scoreDetails');
  const feedbackDisplay = document.getElementById('feedbackDisplay');
  const gamesPlayedDisplay = document.getElementById('gamesPlayedDisplay');
  const shareBtn = document.getElementById('shareBtn');
  const restartBtn = document.getElementById('restartBtn');
  const reviewContainer = document.getElementById('reviewContainer');
  const errorContainer = document.getElementById('errorContainer');
  const timerDisplay = document.getElementById("timerDisplay");
  const startScreen = document.getElementById("startScreen");
  const startBtn = document.getElementById("startBtn");
  const gameContainer = document.getElementById("gameContainer");
  const bootSound = document.getElementById("bootSound");
  const progressLabel = document.getElementById("progressLabel");
  const progressFill = document.getElementById("progressFill");

  let gamesPlayed = parseInt(localStorage.getItem("gamesPlayed") || "0", 10);

  function checkCooldown() {
    const lastPlayed = localStorage.getItem("lastPlayedDate");
    if (!lastPlayed) return true;
    return new Date(lastPlayed).toDateString() !== new Date().toDateString();
  }
  function setLastPlayed() { localStorage.setItem("lastPlayedDate", new Date().toISOString()); }
  function getNextPlayTime() {
    const t = new Date(); t.setDate(t.getDate()+1); t.setHours(0,0,0,0); return t;
  }

  function showError(msg) {
    errorContainer.classList.remove('hidden');
    errorContainer.className = "errorBox";
    errorContainer.textContent = msg;
  }
  function clearError() { errorContainer.classList.add('hidden'); errorContainer.textContent = ""; }

  function normalizeQuiz(raw) {
    if (!Array.isArray(raw)) return null;
    const arr = raw.slice(0,10).map(x => ({
      id: x.id,
      q: String(x.q ?? ""),
      options: Array.isArray(x.options) ? x.options.map(String).slice(0,4) : [],
      answer: String(x.answer ?? ""),
      explanation: String(x.explanation ?? ""),
      kind: String(x.kind ?? "safe")
    })).filter(x => x.q && x.options.length === 4 && x.answer);
    return arr.length === 10 ? arr : null;
  }

  async function fetchWithTimeout(url, options={}, ms=30000) {
    const ctrl = new AbortController();
    const id = setTimeout(() => ctrl.abort(), ms);
    try { return await fetch(url, {...options, signal: ctrl.signal}); }
    finally { clearTimeout(id); }
  }

  async function loadQuestions() {
    const playedIds = JSON.parse(localStorage.getItem('playedIds') || '[]');
    const opts = { method:"POST", headers:{"Content-Type":"application/json"}, cache:"no-store", body:JSON.stringify({playedIds}) };
    let res;
    try { res = await fetchWithTimeout(API_URL, opts, 30000); }
    catch(e) { res = await fetchWithTimeout(API_URL, opts, 35000); }
    if (!res || !res.ok) throw new Error("Backend error (HTTP " + (res ? res.status : "‚Äî") + ")");
    const raw = await res.json();
    const quiz = normalizeQuiz(raw);
    if (!quiz) throw new Error("Quiz invalide.");
    questions = quiz;
  }

  function stopTimer() { if (timerId) { clearInterval(timerId); timerId = null; } }
  function startTimer() {
    stopTimer(); timeLeft = QUESTION_TIME;
    timerDisplay.classList.remove("hidden");
    timerDisplay.textContent = `‚è± ${timeLeft}`;
    timerDisplay.classList.remove("timer-urgent");
    timerId = setInterval(() => {
      timeLeft--;
      timerDisplay.textContent = `‚è± ${timeLeft}`;
      if (timeLeft <= 10) timerDisplay.classList.add("timer-urgent");
      else timerDisplay.classList.remove("timer-urgent");
      if (timeLeft <= 0) { stopTimer(); advanceQuestion(); }
    }, 1000);
  }

  const LETTERS = ['A','B','C','D'];

  function updateProgress() {
    if (progressLabel) progressLabel.textContent = `Question ${current+1} / ${questions.length}`;
    if (progressFill) progressFill.style.width = `${((current+1)/questions.length)*100}%`;
  }

  function showQuestion() {
    clearError(); updateProgress();
    const qObj = questions[current];
    questionContainer.innerHTML = `
      <div class="question-meta">Question ${current+1}</div>
      <div class="question">${qObj.q}</div>
    `;
    optionsContainer.innerHTML = '';
    nextBtn.disabled = (userAnswers[current] == null);
    doubtBtn.classList.remove("hidden");
    doubtBtn.textContent = "‚ö† Signaler une anomalie IA";
    doubtBtn.disabled = false;

    qObj.options.forEach((opt, idx) => {
      const btn = document.createElement('button');
      btn.innerHTML = `<span class="option-letter">${LETTERS[idx]}</span>${opt}`;
      if (userAnswers[current] === opt) btn.classList.add('selected');
      btn.onclick = () => {
        userAnswers[current] = opt;
        Array.from(optionsContainer.children).forEach(b => b.classList.remove('selected'));
        btn.classList.add('selected');
        nextBtn.disabled = false;
      };
      optionsContainer.appendChild(btn);
    });
    startTimer();
  }

  function advanceQuestion() {
    const qObj = questions[current];
    const selected = userAnswers[current];
    const isDoubt = (selected === "__DOUBT__");
    if (qObj.kind === "halu") { if (isDoubt) vigilance += 1; }
    else { if (!isDoubt && selected === qObj.answer) score += 1; }
    current++;
    if (current < questions.length) { showQuestion(); }
    else { stopTimer(); timerDisplay.classList.add("hidden"); setLastPlayed(); showResult(); }
  }

  nextBtn.onclick = () => { stopTimer(); advanceQuestion(); };
  doubtBtn.onclick = () => { doubtBtn.disabled=true; userAnswers[current]="__DOUBT__"; stopTimer(); advanceQuestion(); };

  function showResult() {
    quizDiv.classList.add('hidden');
    resultDiv.classList.remove('hidden');

    gamesPlayed++;
    localStorage.setItem("gamesPlayed", String(gamesPlayed));
    const playedIds = JSON.parse(localStorage.getItem('playedIds') || '[]');
    const currentIds = questions.map(q => q.id).filter(id => id != null);
    localStorage.setItem('playedIds', JSON.stringify([...new Set([...playedIds, ...currentIds])].slice(-1000)));

    const totalHalu = questions.filter(q => q.kind === "halu").length;
    const totalSafe = questions.length - totalHalu;
    const scoreTotal = score + vigilance;
    const scoreMax = questions.length;

    // TOKEN CANVAS
    const tokenContainer = document.getElementById('tokenContainer');
    const tokenCanvas = document.getElementById('tokenCanvas');
    const tokenImage = document.getElementById('tokenImage');
    tokenContainer.classList.remove('hidden');
    tokenImage.classList.add('hidden'); tokenImage.src = "";
    tokenCanvas.classList.remove('hidden');

    const cssW = Math.min(500, tokenContainer.clientWidth - 2);
    const w = cssW, h = Math.round(w * 0.46);
    const dpr = window.devicePixelRatio || 1;
    tokenCanvas.style.width = w+"px"; tokenCanvas.style.height = h+"px";
    tokenCanvas.width = Math.round(w*dpr); tokenCanvas.height = Math.round(h*dpr);
    const ctx = tokenCanvas.getContext("2d");
    ctx.setTransform(dpr,0,0,dpr,0,0);

    ctx.fillStyle = "#13161d";
    ctx.fillRect(0,0,w,h);

    // Subtle grid lines
    ctx.strokeStyle = "rgba(255,255,255,0.03)";
    ctx.lineWidth = 1;
    for(let x=0; x<w; x+=40) { ctx.beginPath(); ctx.moveTo(x,0); ctx.lineTo(x,h); ctx.stroke(); }
    for(let y=0; y<h; y+=40) { ctx.beginPath(); ctx.moveTo(0,y); ctx.lineTo(w,y); ctx.stroke(); }

    const accentColor = scoreTotal >= 10 ? "#e8ff47" : scoreTotal >= 6 ? "#4facfe" : "#ff4d6d";
    ctx.fillStyle = accentColor;
    ctx.fillRect(0, 0, w, 3);

    ctx.textAlign = "center";
    let labelFSize = Math.min(11, Math.floor(w * 0.025));
    ctx.font = `500 ${labelFSize}px DM Mono, monospace`;
    ctx.fillStyle = "rgba(255,255,255,0.3)";
    ctx.fillText("IQAI ‚Äî AI VIGILANCE ASSESSMENT", w/2, Math.round(h*0.22));

    let scoreFSize = Math.min(44, Math.floor(w * 0.1));
    ctx.font = `800 ${scoreFSize}px DM Sans, sans-serif`;
    ctx.fillStyle = accentColor;
    ctx.fillText(`${scoreTotal}/${scoreMax}`, w/2, Math.round(h*0.57));

    const badgeLabel = scoreTotal >= 10 ? "CERTIFIED SAFE BRAIN" : scoreTotal >= 6 ? "I QUIT AI" : "AI BRAINWASHED";
    let bFSize = Math.min(12, Math.floor(w * 0.028));
    ctx.font = `500 ${bFSize}px DM Mono, monospace`;
    ctx.fillStyle = "rgba(255,255,255,0.45)";
    ctx.fillText(badgeLabel, w/2, Math.round(h*0.74));

    ctx.font = `400 ${Math.floor(bFSize*0.82)}px DM Mono, monospace`;
    ctx.fillStyle = "rgba(255,255,255,0.22)";
    ctx.fillText(`${gamesPlayed} parties jou√©es`, w/2, Math.round(h*0.88));

    // SCORE CARDS
    if (scoreTotal >= 6) {
      scoreDetails.innerHTML = `
        <div class="score-card"><div class="sc-label">Questions classiques</div><div class="sc-value accent">${score}<span style="font-size:0.6em;color:var(--text-muted)">/${totalSafe}</span></div></div>
        <div class="score-card"><div class="sc-label">Anomalies d√©tect√©es</div><div class="sc-value accent">${vigilance}<span style="font-size:0.6em;color:var(--text-muted)">/${totalHalu}</span></div></div>
      `;
    } else {
      scoreDetails.innerHTML = `
        <div class="score-card" style="grid-column:1/-1"><div class="sc-label">Score total</div><div class="sc-value">${scoreTotal}<span style="font-size:0.6em;color:var(--text-muted)">/${scoreMax}</span></div></div>
      `;
    }

    feedbackDisplay.textContent = scoreTotal>=8 ? "Tr√®s solide. Revenez demain." : scoreTotal>=5 ? "Bien jou√©. Continuez." : "Courage. Revenez demain.";
    gamesPlayedDisplay.textContent = `PARTIES JOU√âES : ${gamesPlayed}`;
    doubtBtn.classList.add("hidden");

    setTimeout(() => { if (window.showNotifPopup) window.showNotifPopup(); }, 2000);

    restartBtn.onclick = () => {
      if (!checkCooldown()) {
        const diff = getNextPlayTime() - new Date();
        const hh = Math.floor(diff/(1000*60*60)), mm = Math.floor((diff%(1000*60*60))/(1000*60));
        alert(`D√©j√† jou√© aujourd'hui. Revenez √† minuit (dans ${hh}h ${mm}min)`);
        return;
      }
      location.reload();
    };

    shareBtn.onclick = () => {
      const text = `üß† IQAI Test ‚Äî Score: ${scoreTotal}/${scoreMax} (${score} safe + ${vigilance} hallus). √Ä toi de jouer : `;
      window.open("https://www.linkedin.com/sharing/share-offsite/?url="+encodeURIComponent(window.location.href)+"&summary="+encodeURIComponent(text), '_blank');
    };

    reviewContainer.innerHTML = "<h3>Revue des questions</h3>";
    questions.forEach((q, i) => {
      const user = userAnswers[i];
      const isDoubt = (user === "__DOUBT__");
      const isCorrectSafe = (q.kind === "safe" && user === q.answer);
      const isCorrectHalu = (q.kind === "halu" && isDoubt);
      let statusHTML = "";

      if (q.kind === "halu") {
        statusHTML = isCorrectHalu
          ? `<div class="haluBanner ok">‚úÖ Anomalie d√©tect√©e (+1 pt)</div>`
          : `<div class="haluBanner bad">‚ùå Information erron√©e valid√©e (0 pt)</div>`;
      } else {
        if (isCorrectSafe) statusHTML = `<div style="color:var(--success);font-weight:600;margin-top:8px;font-size:0.88em;">‚úÖ Bonne r√©ponse (+1 pt)</div>`;
        else if (isDoubt) statusHTML = `<div style="color:var(--danger);font-weight:600;margin-top:8px;font-size:0.88em;">‚ùå Faux positif : information valide signal√©e (0 pt)</div>`;
        else statusHTML = `<div style="color:var(--danger);font-weight:600;margin-top:8px;font-size:0.88em;">‚ùå Mauvaise r√©ponse (0 pt)</div>`;
      }

      const div = document.createElement('div');
      div.className = "reviewItem";
      div.innerHTML = `
        <strong>Q${i+1} :</strong> ${q.q}<br>
        <strong>Votre r√©ponse :</strong> <span class="answerTag ${isCorrectSafe||isCorrectHalu?'ok':'bad'}">${isDoubt?"‚ö† Anomalie signal√©e":(user||"Temps √©coul√©")}</span><br>
        <strong>R√©ponse correcte :</strong> ${q.kind==="halu"?"Incoh√©rence IA":q.answer}<br>
        <div style="margin-top:5px;font-size:0.83em;color:var(--text-muted);font-style:italic;">${q.explanation}</div>
        ${statusHTML}
      `;
      reviewContainer.appendChild(div);
    });

    loadLeaderboard();
  }

  async function startGame() {
    if (!checkCooldown()) {
      const diff = getNextPlayTime() - new Date();
      const hh = Math.floor(diff/(1000*60*60)), mm = Math.floor((diff%(1000*60*60))/(1000*60));
      quizDiv.innerHTML = `
        <div class="cooldownMessage">
          <h2>Revenez demain</h2>
          <p>Vous avez d√©j√† compl√©t√© votre √©valuation aujourd'hui.<br>
          Prochaine session √† <strong>minuit</strong> (dans ${hh}h ${mm}min)</p>
          <button onclick="location.reload()">‚Ü∫ Rafra√Æchir</button>
        </div>
      `;
      return;
    }
    clearError();
    resultDiv.classList.add('hidden');
    quizDiv.classList.remove('hidden');
    reviewContainer.innerHTML = "";
    current=0; score=0; vigilance=0;
    userAnswers = new Array(10).fill(null);
    nextBtn.disabled = true;
    optionsContainer.innerHTML = "";
    questionContainer.innerHTML = `<div class="question" style="color:var(--text-muted);">Chargement de l'√©valuation‚Ä¶</div>`;
    doubtBtn.classList.add("hidden");
    doubtBtn.disabled = false;

    try {
      await loadQuestions();
      showQuestion();
    } catch(e) {
      stopTimer(); timerDisplay.classList.add("hidden");
      showError("Erreur de chargement. ("+(e?.message||e)+")");
      questionContainer.innerHTML = `<div class="question" style="color:var(--text-muted);">Impossible de charger l'√©valuation.</div>`;
      nextBtn.disabled = true;
    }
  }

  startBtn.onclick = () => {
    window.quizStartTime = Date.now();
    startScreen.classList.add("hidden");
    gameContainer.classList.remove("hidden");
    try {
      bootSound.pause(); bootSound.currentTime=0; bootSound.load();
      const p = bootSound.play();
      if (p && typeof p.catch==="function") p.catch(()=>{});
    } catch(e) {}
    startGame();
  };

  function showNotifPopup() {
    if (window.OneSignalDeferred) {
      OneSignalDeferred.push(async function(OneSignal) {
        try {
          const ok = await OneSignal.Notifications.isPushSupported();
          if (ok && OneSignal.Notifications.permission !== "granted")
            document.getElementById('notifPopup')?.classList.remove('hidden');
        } catch(e) { console.error('OneSignal:', e); }
      });
    }
  }

  document.addEventListener('DOMContentLoaded', () => {
    const popup = document.getElementById('notifPopup');
    document.getElementById('notifAccept')?.addEventListener('click', async () => {
      popup?.classList.add('hidden');
      if (window.OneSignalDeferred) {
        OneSignalDeferred.push(async function(OneSignal) {
          try { await OneSignal.Notifications.requestPermission(); await OneSignal.User.addTag("status","joueur_actif"); }
          catch(e) { console.error('OneSignal:', e); }
        });
      }
    });
    document.getElementById('notifDecline')?.addEventListener('click', () => popup?.classList.add('hidden'));
  });
  window.showNotifPopup = showNotifPopup;

  async function loadLeaderboard() {
    const list = document.getElementById('leaderboardList');
    if (!list) return;
    try {
      const res = await fetch('/api/leaderboard');
      const top3 = await res.json();
      if (!top3 || top3.length === 0) {
        list.innerHTML = "<p style='font-size:0.85em;color:var(--text-muted);font-style:italic;'>Personne n'a encore jou√© aujourd'hui.</p>";
      } else {
        list.innerHTML = top3.map((p,i) => `
          <div class="leaderboard-row">
            <span>${i===0?'ü•á':i===1?'ü•à':'ü•â'} <strong>${p.pseudo}</strong></span>
            <span style="font-family:var(--font-display);font-size:0.82em;color:var(--accent);">${p.score} pts</span>
          </div>
        `).join('');
      }
    } catch(err) {
      list.innerHTML = "<p style='color:var(--danger);font-size:0.85em;'>Classement temporairement indisponible.</p>";
    }
  }

  async function submitScore() {
    const pseudoInput = document.getElementById('playerPseudo');
    const pseudo = pseudoInput?.value.trim() || "";
    if (!pseudo) { alert("Il nous faut un pseudo !"); return; }
    if (pseudo.length < 2) { alert("Pseudo trop court (2 min)"); return; }
    const timeTaken = Math.floor((Date.now() - (window.quizStartTime||Date.now())) / 1000);
    const finalScore = (score||0) + (vigilance||0);
    try {
      const res = await fetch('/api/leaderboard', {
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({pseudo, score:finalScore, timeTaken})
      });
      if (res.ok) {
        const area = document.getElementById('pseudoInputArea');
        if (area) area.style.display='none';
        await loadLeaderboard();
      } else { alert("Probl√®me technique lors de l'envoi."); }
    } catch(e) { alert("Impossible de joindre le serveur."); }
  }
  window.submitScore = submitScore;
</script>
</body>
</html>
