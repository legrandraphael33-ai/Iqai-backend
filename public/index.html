<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>IQAI Test â€” AI Vigilance Platform</title>
<link rel="icon" href="data:,">

<link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=DM+Sans:wght@400;500;600;700;800&family=DM+Mono:wght@500&display=swap" rel="stylesheet">

<script src="https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js" defer></script>
<script>
  window.OneSignalDeferred = window.OneSignalDeferred || [];
  OneSignalDeferred.push(async function(OneSignal) {
    await OneSignal.init({
      appId: "dc73bf96-dbcf-4498-ab4d-5639c66b16ea",
      safari_web_id: "web.onesignal.auto.10309993-875c-4384-934c-26792f444f2b",
      notifyButton: { enable: true },
      allowLocalhostAsSecureOrigin: true,
    });
  });
</script>

<style>
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

  :root {
    --bg:       #f0f4f8;
    --surface:  #ffffff;
    --surface2: #f7f9fc;
    --border:   rgba(0,0,0,0.07);
    --border2:  rgba(0,0,0,0.11);
    --text:     #1a2332;
    --muted:    #6b7a99;
    --accent:   #1d6fe5;
    --accent2:  #00b899;
    --danger:   #e03f5a;
    --warn:     #f59e0b;
    --success:  #16a34a;

    --title-font: 'Press Start 2P', monospace;
    --body-font:  'DM Sans', system-ui, sans-serif;
    --mono-font:  'DM Mono', monospace;
  }

  body {
    min-height: 100vh;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: flex-start;
    background: var(--bg);
    padding: 32px 16px 48px;
    font-family: var(--body-font);
    color: var(--text);
  }

  /* subtle grid pattern on bg */
  body::before {
    content: '';
    position: fixed;
    inset: 0;
    background-image:
      linear-gradient(rgba(29,111,229,0.04) 1px, transparent 1px),
      linear-gradient(90deg, rgba(29,111,229,0.04) 1px, transparent 1px);
    background-size: 40px 40px;
    pointer-events: none;
    z-index: 0;
  }

  /* â”€â”€ HEADER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .site-header {
    width: 100%;
    max-width: 600px;
    display: flex;
    flex-direction: column;
    align-items: center;
    margin-bottom: 28px;
    position: relative;
    z-index: 1;
  }

  .logo-badge {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    background: rgba(29,111,229,0.08);
    border: 1px solid rgba(29,111,229,0.2);
    border-radius: 999px;
    padding: 5px 14px 5px 8px;
    margin-bottom: 16px;
    font-size: 0.72em;
    font-weight: 600;
    color: var(--accent);
    letter-spacing: 0.5px;
  }
  .logo-badge .dot {
    width: 7px; height: 7px;
    border-radius: 50%;
    background: var(--accent2);
    animation: pulse 2s ease-in-out infinite;
  }
  @keyframes pulse {
    0%,100% { opacity:1; transform:scale(1); }
    50%      { opacity:0.5; transform:scale(0.75); }
  }

  h1 {
    font-family: var(--title-font);
    font-size: clamp(1.4em, 4vw, 2em);
    text-align: center;
    line-height: 1.2;
    letter-spacing: 1px;
    margin-bottom: 8px;
    color: var(--text);
  }
  h1 span { display: inline-block; }
  .title-sep { margin: 0 10px; opacity: 0; color: var(--muted); }
  .title-sep.cursor-on { opacity: 1; animation: caretBlink 1.7s steps(1,end) infinite; }
  @keyframes caretBlink { 0%,49%{ opacity:1; } 50%,100%{ opacity:0; } }

  .tagline {
    font-size: 0.82em;
    font-weight: 500;
    color: var(--muted);
    letter-spacing: 1.5px;
    text-transform: uppercase;
    text-align: center;
  }

  /* â”€â”€ CARD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .container {
    max-width: 580px;
    width: 100%;
    background: var(--surface);
    border: 1px solid var(--border2);
    border-radius: 16px;
    padding: 28px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.05), 0 16px 48px rgba(29,111,229,0.07);
    position: relative;
    z-index: 1;
  }

  /* â”€â”€ START SCREEN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  #startScreen .intro-text {
    text-align: center;
    margin-bottom: 24px;
  }
  #startScreen .intro-text h2 {
    font-size: 1.1em;
    font-weight: 700;
    margin-bottom: 10px;
    color: var(--text);
  }
  #startScreen .intro-text p {
    font-size: 0.88em;
    color: var(--muted);
    line-height: 1.6;
  }

  .stat-row {
    display: grid;
    grid-template-columns: 1fr 1fr 1fr;
    gap: 10px;
    margin-bottom: 24px;
  }
  .stat-cell {
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 14px 10px;
    text-align: center;
  }
  .stat-cell .stat-val {
    font-family: var(--mono-font);
    font-size: 1.3em;
    font-weight: 500;
    color: var(--accent);
    display: block;
    margin-bottom: 4px;
  }
  .stat-cell .stat-lbl {
    font-size: 0.72em;
    color: var(--muted);
    line-height: 1.3;
  }

  .rules-block {
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 16px;
    margin-bottom: 24px;
    font-size: 0.86em;
    line-height: 1.7;
    color: var(--muted);
  }
  .rules-block .rule { display: flex; align-items: flex-start; gap: 10px; margin-bottom: 6px; }
  .rules-block .rule:last-child { margin-bottom: 0; }
  .rules-block .rule .icon { flex-shrink: 0; }

  #startBtn {
    width: 100%;
    padding: 16px;
    font-size: 0.82em;
    font-weight: 700;
    border: none;
    border-radius: 12px;
    background: var(--accent);
    color: #fff;
    cursor: pointer;
    transition: filter 0.15s, transform 0.1s;
    font-family: var(--title-font);
    letter-spacing: 0.5px;
    box-shadow: 0 4px 16px rgba(29,111,229,0.3);
  }
  #startBtn:hover  { filter: brightness(1.08); }
  #startBtn:active { transform: translateY(1px); }

  /* â”€â”€ PROGRESS BAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .progress-wrap {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 20px;
  }
  .progress-track {
    flex: 1;
    height: 4px;
    background: var(--border2);
    border-radius: 99px;
    overflow: hidden;
  }
  .progress-fill {
    height: 100%;
    background: linear-gradient(90deg, var(--accent), var(--accent2));
    border-radius: 99px;
    transition: width 0.4s ease;
    width: 0%;
  }
  .progress-label {
    font-family: var(--mono-font);
    font-size: 0.78em;
    color: var(--muted);
    white-space: nowrap;
    min-width: 40px;
    text-align: right;
  }

  /* â”€â”€ TIMER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  #timerLine { display: flex; justify-content: flex-end; margin-bottom: 4px; }
  #timerDisplay {
    font-family: var(--mono-font);
    font-size: 0.8em;
    color: var(--muted);
    background: var(--surface2);
    border: 1px solid var(--border);
    padding: 4px 12px;
    border-radius: 999px;
    transition: color 0.3s, border-color 0.3s;
  }
  #timerDisplay.timer-urgent {
    color: var(--danger);
    border-color: rgba(224,63,90,0.35);
    background: rgba(224,63,90,0.05);
  }

  /* â”€â”€ QUESTION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .question {
    font-size: 1em;
    font-weight: 700;
    line-height: 1.5;
    margin-bottom: 18px;
    color: var(--text);
  }
  .q-num {
    font-family: var(--mono-font);
    color: var(--accent);
    font-size: 0.75em;
    display: block;
    margin-bottom: 6px;
    letter-spacing: 0.5px;
  }

  /* â”€â”€ OPTIONS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .options button {
    display: flex;
    align-items: center;
    gap: 12px;
    width: 100%;
    padding: 13px 16px;
    margin-bottom: 8px;
    border: 1px solid var(--border2);
    border-radius: 10px;
    background: var(--surface2);
    color: var(--text);
    cursor: pointer;
    font-weight: 500;
    font-family: var(--body-font);
    font-size: 0.93em;
    text-align: left;
    transition: border-color 0.15s, background 0.15s;
  }
  .options button:hover { border-color: var(--accent); background: rgba(29,111,229,0.04); }
  .options button.selected { border-color: var(--accent); background: rgba(29,111,229,0.08); }
  .opt-check {
    width: 20px; height: 20px;
    border-radius: 6px;
    border: 1.5px solid var(--border2);
    display: flex; align-items: center; justify-content: center;
    flex-shrink: 0;
    font-size: 0.75em;
    transition: border-color 0.15s, background 0.15s;
  }
  .options button.selected .opt-check {
    border-color: var(--accent);
    background: var(--accent);
    color: #fff;
    font-weight: 900;
  }

  /* â”€â”€ BUTTONS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  #nextBtn {
    width: 100%;
    padding: 13px;
    margin-top: 8px;
    border: 1px solid var(--border2);
    border-radius: 10px;
    background: var(--surface2);
    color: var(--text);
    cursor: pointer;
    font-weight: 600;
    font-family: var(--body-font);
    font-size: 0.93em;
    transition: background 0.15s;
  }
  #nextBtn:not(:disabled):hover { background: #eef2f8; }
  #nextBtn:disabled { opacity: 0.35; cursor: not-allowed; }

  #doubtBtn {
    width: 100%;
    padding: 14px;
    margin-top: 8px;
    border-radius: 10px;
    border: 1.5px solid rgba(224,63,90,0.4);
    background: rgba(224,63,90,0.05);
    color: var(--danger);
    font-weight: 700;
    font-size: 0.9em;
    cursor: pointer;
    font-family: var(--body-font);
    transition: background 0.15s, border-color 0.15s;
  }
  #doubtBtn:hover:not(:disabled) { background: rgba(224,63,90,0.1); border-color: var(--danger); }
  #doubtBtn:disabled { opacity: 0.35; cursor: not-allowed; }

  /* â”€â”€ ERROR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .errorBox {
    margin-top: 10px; padding: 12px; border-radius: 10px;
    background: rgba(224,63,90,0.06);
    border: 1px solid rgba(224,63,90,0.2);
    color: var(--danger); font-weight: 600; font-size: 0.9em;
  }

  /* â”€â”€ TOKEN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  #tokenContainer {
    width: 100%;
    margin: 0 auto 24px;
    border-radius: 14px;
    overflow: hidden;
    border: 1px solid var(--border2);
    box-shadow: 0 4px 20px rgba(0,0,0,0.08);
  }
  #tokenCanvas { display: block; width: 100%; height: auto; }

  /* â”€â”€ VALIDATION BADGE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .validation-badge {
    text-align: center;
    padding: 20px;
    border-radius: 14px;
    margin-bottom: 20px;
    border: 1.5px solid;
  }
  .validation-badge.validated {
    background: rgba(22,163,74,0.06);
    border-color: rgba(22,163,74,0.25);
  }
  .validation-badge.not-validated {
    background: rgba(224,63,90,0.06);
    border-color: rgba(224,63,90,0.25);
  }
  .validation-badge .vb-title {
    font-size: 1.1em;
    font-weight: 800;
    margin-bottom: 6px;
  }
  .validation-badge.validated .vb-title { color: var(--success); }
  .validation-badge.not-validated .vb-title { color: var(--danger); }
  .validation-badge .vb-sub {
    font-size: 0.84em;
    color: var(--muted);
    line-height: 1.5;
  }

  /* â”€â”€ SCORE CARDS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  #scoreDetails {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 10px;
    margin-bottom: 20px;
  }
  .score-card {
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 16px;
    text-align: center;
  }
  .score-card .sc-val {
    font-family: var(--mono-font);
    font-size: 1.6em;
    font-weight: 500;
    color: var(--accent);
    display: block;
    margin-bottom: 4px;
  }
  .score-card .sc-lbl { font-size: 0.78em; color: var(--muted); }

  /* â”€â”€ HOW IT WORKS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  #howItWorks {
    margin-top: 16px;
    padding: 14px;
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 10px;
    font-size: 0.82em;
    line-height: 1.8;
    color: var(--muted);
  }
  #howItWorks strong { color: var(--text); font-weight: 600; display: block; margin-bottom: 4px; }

  /* â”€â”€ REVIEW â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  #reviewContainer { margin-top: 20px; }
  #reviewContainer h3 {
    font-size: 0.8em;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 1px;
    color: var(--muted);
    margin-bottom: 12px;
  }
  .reviewItem {
    padding: 14px;
    border: 1px solid var(--border);
    border-radius: 10px;
    margin-bottom: 8px;
    background: var(--surface2);
    line-height: 1.5;
    font-size: 0.88em;
    color: var(--text);
  }
  .haluBanner {
    margin-top: 8px; padding: 8px 12px; border-radius: 8px;
    font-weight: 600; font-size: 0.88em; line-height: 1.4;
    background: rgba(224,63,90,0.07);
    border: 1px solid rgba(224,63,90,0.2);
    color: var(--danger);
  }
  .haluBanner.ok {
    background: rgba(22,163,74,0.07);
    border-color: rgba(22,163,74,0.2);
    color: var(--success);
  }
  .answerTag {
    display: inline-block; padding: 2px 8px; border-radius: 6px; font-weight: 600; font-size: 0.9em;
  }
  .answerTag.ok  { background: rgba(22,163,74,0.1); border:1px solid rgba(22,163,74,0.25); color: var(--success); }
  .answerTag.bad { background: rgba(224,63,90,0.1); border:1px solid rgba(224,63,90,0.25); color: var(--danger); }

  /* â”€â”€ COOLDOWN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .cooldownMessage { text-align: center; padding: 24px; }
  .cooldownMessage h2 { font-size: 1.2em; margin-bottom: 12px; color: var(--text); }
  .cooldownMessage p  { font-size: 0.9em; line-height: 1.6; color: var(--muted); }

  /* â”€â”€ NOTIF POPUP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .notifPopup { position:fixed;inset:0;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:9999;padding:20px;backdrop-filter:blur(4px); }
  .notifPopup.hidden { display:none; }
  .notifPopupContent { background:var(--surface);border:1px solid var(--border2);border-radius:18px;padding:32px;max-width:420px;width:100%;text-align:center;box-shadow:0 24px 64px rgba(0,0,0,0.15);animation:popupSlide 0.3s ease; }
  @keyframes popupSlide { from{transform:translateY(-20px);opacity:0;} to{transform:translateY(0);opacity:1;} }
  .notifPopup h2 { font-size:1.1em;margin-bottom:10px;color:var(--text); }
  .notifPopup p  { font-size:0.9em;line-height:1.6;color:var(--muted);margin-bottom:22px; }
  .notifPopup .btnPrimary { width:100%;padding:13px;border:none;border-radius:10px;background:var(--accent);color:#fff;font-weight:700;font-size:0.95em;cursor:pointer;margin-bottom:10px;font-family:var(--body-font);transition:filter 0.15s; }
  .notifPopup .btnPrimary:hover { filter:brightness(1.08); }
  .notifPopup .btnSecondary { background:none;border:none;color:var(--muted);font-size:0.85em;cursor:pointer;padding:8px; }

  .hidden { display: none; }

  @media (max-width: 420px) {
    h1 { font-size: 1.2em; }
    .stat-row { grid-template-columns: 1fr 1fr; }
    .stat-row .stat-cell:last-child { grid-column: span 2; }
  }
</style>
</head>

<body>

  <div class="site-header">
    <div class="logo-badge">
      <span class="dot"></span>
      AI VIGILANCE PLATFORM
    </div>
    <h1 id="title"></h1>
    <p class="tagline">I Quit AI â€” Formation Vigilance IA</p>
  </div>

  <!-- START -->
  <div id="startScreen" class="container">
    <div class="intro-text">
      <h2>ÃŠtes-vous plus vif que l'algorithme ?</h2>
      <p>10 questions gÃ©nÃ©rÃ©es par IA. Certaines sont correctes. D'autres sont des hallucinations volontaires. Votre mission : faire la diffÃ©rence.</p>
    </div>
    <div class="stat-row">
      <div class="stat-cell"><span class="stat-val">10</span><span class="stat-lbl">Questions / session</span></div>
      <div class="stat-cell"><span class="stat-val">30s</span><span class="stat-lbl">DÃ©lai par question</span></div>
      <div class="stat-cell"><span class="stat-val">7/10</span><span class="stat-lbl">Seuil de validation</span></div>
    </div>
    <div class="rules-block">
      <div class="rule"><span class="icon">âœ…</span><span>Bonne rÃ©ponse (question fiable) â†’ <strong>+1 point</strong></span></div>
      <div class="rule"><span class="icon">âœ…</span><span>Hallucination dÃ©tectÃ©e (bouton Anomalie) â†’ <strong>+1 point</strong></span></div>
      <div class="rule"><span class="icon">âŒ</span><span>Mauvaise rÃ©ponse ou hallucination manquÃ©e â†’ <strong>0 point</strong></span></div>
    </div>
    <button id="startBtn">â–¶ LANCER L'Ã‰VALUATION</button>
  </div>

  <!-- GAME -->
  <div class="container hidden" id="gameContainer">
    <div id="quiz">
      <div class="progress-wrap">
        <div class="progress-track"><div class="progress-fill" id="progressFill"></div></div>
        <div class="progress-label" id="progressLabel">0 / 10</div>
      </div>
      <div id="timerLine">
        <div id="timerDisplay" class="hidden">â± 30</div>
      </div>
      <div id="questionContainer"></div>
      <div class="options" id="optionsContainer"></div>
      <button id="nextBtn" disabled>Suivant â†’</button>
      <button id="doubtBtn" class="hidden">âš ï¸ SIGNALER UNE ANOMALIE IA</button>
      <div id="errorContainer" class="hidden"></div>
    </div>

    <div id="result" class="hidden">

      <!-- TOKEN -->
      <div id="tokenContainer" class="hidden">
        <canvas id="tokenCanvas" width="500" height="250"></canvas>
      </div>

      <!-- VALIDATION BADGE -->
      <div id="validationBadge"></div>

      <!-- SCORE CARDS -->
      <div id="scoreDetails"></div>

      <!-- HOW IT WORKS -->
      <div id="howItWorks">
        <strong>ğŸ“Š Calcul du score</strong>
        âœ… Bonne rÃ©ponse (safe) = +1 pt &nbsp;|&nbsp; âœ… Hallucination dÃ©tectÃ©e = +1 pt<br>
        âŒ Mauvaise rÃ©ponse = 0 pt &nbsp;|&nbsp; âŒ Hallucination manquÃ©e = 0 pt
      </div>

      <!-- REVIEW -->
      <div id="reviewContainer"></div>

    </div>
  </div>

  <audio id="bootSound" preload="auto" playsinline>
    <source src="Gameboy.mp3" type="audio/mpeg">
  </audio>

  <div id="notifPopup" class="notifPopup hidden">
    <div class="notifPopupContent">
      <h2>ğŸ”” Rappel quotidien</h2>
      <p>Recevez une notification chaque jour pour maintenir votre niveau de vigilance IA.</p>
      <button id="notifAccept" class="btnPrimary">Activer les rappels</button>
      <button id="notifDecline" class="btnSecondary">Plus tard</button>
    </div>
  </div>

<script>
  // ---------- TITLE ----------
  const colors=["#1d6fe5","#00b899","#16a34a","#f59e0b","#1d6fe5","#e03f5a"];
  const titleContainer=document.getElementById("title");
  const parts=["IQAI","Test"];
  let cursorSepEl=null,cursorTimeoutId=null,hasShownCursor=false;
  function clearTitle(){titleContainer.innerHTML="";cursorSepEl=null;hasShownCursor=false;if(cursorTimeoutId){clearTimeout(cursorTimeoutId);cursorTimeoutId=null;}}
  function showCursorBlink(){if(hasShownCursor)return;if(cursorSepEl){cursorSepEl.classList.add("cursor-on");hasShownCursor=true;}}
  function animateTitle({letterDelayMs=140,initialDelayMs=80}={}){
    clearTitle();const spans=[];let colorIndex=0;
    function addColoredText(text){text.split("").forEach((c,i)=>{const s=document.createElement("span");s.textContent=c;s.style.opacity="0";s.style.transform="scale(0.85)";s.style.transition="opacity 180ms ease, transform 180ms ease";s.style.color=colors[(colorIndex+i)%colors.length];spans.push(s);titleContainer.appendChild(s);});colorIndex+=text.length;}
    addColoredText(parts[0]);
    cursorSepEl=document.createElement("span");cursorSepEl.className="title-sep";cursorSepEl.textContent="|";titleContainer.appendChild(cursorSepEl);
    addColoredText(parts[1]);
    spans.forEach((s,i)=>{setTimeout(()=>{s.style.opacity="1";s.style.transform="scale(1)";},initialDelayMs+(i*letterDelayMs));});
    return initialDelayMs+(spans.length*letterDelayMs)+220;
  }

  // ---------- STATE ----------
  const API_URL="https://iqai-backend.vercel.app/api/quiz";
  let questions=[],current=0,score=0,vigilance=0,userAnswers=[];
  const QUESTION_TIME=30;
  let timeLeft=QUESTION_TIME,timerId=null;

  // ---------- DOM ----------
  const questionContainer=document.getElementById('questionContainer');
  const optionsContainer=document.getElementById('optionsContainer');
  const nextBtn=document.getElementById('nextBtn');
  const doubtBtn=document.getElementById('doubtBtn');
  const quizDiv=document.getElementById('quiz');
  const resultDiv=document.getElementById('result');
  const scoreDetails=document.getElementById('scoreDetails');
  const reviewContainer=document.getElementById('reviewContainer');
  const errorContainer=document.getElementById('errorContainer');
  const timerDisplay=document.getElementById("timerDisplay");
  const startScreen=document.getElementById("startScreen");
  const startBtn=document.getElementById("startBtn");
  const gameContainer=document.getElementById("gameContainer");
  const bootSound=document.getElementById("bootSound");
  const progressFill=document.getElementById("progressFill");
  const progressLabel=document.getElementById("progressLabel");

  let gamesPlayed=parseInt(localStorage.getItem("gamesPlayed")||"0",10);

  function updateProgress(){
    const pct=(current/(questions.length||10))*100;
    progressFill.style.width=pct+"%";
    progressLabel.textContent=current+" / "+(questions.length||10);
  }

  function checkCooldown(){const d=localStorage.getItem("lastPlayedDate");if(!d)return true;return new Date(d).toDateString()!==new Date().toDateString();}
  function setLastPlayed(){localStorage.setItem("lastPlayedDate",new Date().toISOString());}
  function getNextPlayTime(){const t=new Date();t.setDate(t.getDate()+1);t.setHours(0,0,0,0);return t;}

  function showError(msg){errorContainer.classList.remove('hidden');errorContainer.className="errorBox";errorContainer.textContent=msg;}
  function clearError(){errorContainer.classList.add('hidden');errorContainer.className="";errorContainer.textContent="";}

  function normalizeQuiz(raw){
    if(!Array.isArray(raw))return null;
    const arr=raw.slice(0,10).map(x=>({id:x.id,q:String(x.q??""),options:Array.isArray(x.options)?x.options.map(String).slice(0,4):[],answer:String(x.answer??""),explanation:String(x.explanation??""),kind:String(x.kind??"safe")})).filter(x=>x.q&&x.options.length===4&&x.answer);
    return (arr.length===10)?arr:null;
  }

  async function fetchWithTimeout(url,options={},ms=30000){const c=new AbortController();const id=setTimeout(()=>c.abort(),ms);try{return await fetch(url,{...options,signal:c.signal});}finally{clearTimeout(id);}}

  async function loadQuestions(){
    const playedIds=JSON.parse(localStorage.getItem('playedIds')||'[]');
    const opts={method:"POST",headers:{"Content-Type":"application/json"},cache:"no-store",body:JSON.stringify({playedIds})};
    let res;
    try{res=await fetchWithTimeout(API_URL,opts,30000);}catch(e){res=await fetchWithTimeout(API_URL,opts,35000);}
    if(!res||!res.ok)throw new Error("Backend HTTP "+(res?res.status:"â€”"));
    const raw=await res.json();const quiz=normalizeQuiz(raw);
    if(!quiz)throw new Error("Quiz invalide.");
    questions=quiz;
  }

  function stopTimer(){if(timerId){clearInterval(timerId);timerId=null;}}
  function startTimer(){
    stopTimer();timeLeft=QUESTION_TIME;
    timerDisplay.classList.remove("hidden");timerDisplay.textContent=`â± ${timeLeft}`;timerDisplay.classList.remove("timer-urgent");
    timerId=setInterval(()=>{
      timeLeft--;timerDisplay.textContent=`â± ${timeLeft}`;
      if(timeLeft<=10)timerDisplay.classList.add("timer-urgent");else timerDisplay.classList.remove("timer-urgent");
      if(timeLeft<=0){stopTimer();advanceQuestion();}
    },1000);
  }

  function showQuestion(){
    clearError();updateProgress();
    const qObj=questions[current];
    questionContainer.innerHTML=`<div class="question"><span class="q-num">Question ${current+1} / ${questions.length}</span>${qObj.q}</div>`;
    optionsContainer.innerHTML='';
    nextBtn.disabled=(userAnswers[current]==null);
    doubtBtn.classList.remove("hidden");doubtBtn.textContent="âš ï¸ SIGNALER UNE ANOMALIE IA";doubtBtn.disabled=false;
    qObj.options.forEach(opt=>{
      const btn=document.createElement('button');
      const check=document.createElement('span');check.className='opt-check';btn.appendChild(check);
      const label=document.createElement('span');label.textContent=opt;btn.appendChild(label);
      if(userAnswers[current]===opt){btn.classList.add('selected');check.textContent='âœ“';}
      btn.onclick=()=>{
        userAnswers[current]=opt;
        Array.from(optionsContainer.children).forEach(b=>{const c=b.querySelector('.opt-check');const sel=b.querySelector('span:last-child').textContent===opt;b.classList.toggle('selected',sel);c.textContent=sel?'âœ“':'';});
        nextBtn.disabled=false;
      };
      optionsContainer.appendChild(btn);
    });
    startTimer();
  }

  function advanceQuestion(){
    const qObj=questions[current];const selected=userAnswers[current];const isDoubt=(selected==="__DOUBT__");
    if(qObj.kind==="halu"){if(isDoubt)vigilance+=1;}
    else{if(!isDoubt&&selected===qObj.answer)score+=1;}
    current++;updateProgress();
    if(current<questions.length){showQuestion();}
    else{stopTimer();timerDisplay.classList.add("hidden");setLastPlayed();showResult();}
  }

  nextBtn.onclick=()=>{stopTimer();advanceQuestion();};
  doubtBtn.onclick=()=>{doubtBtn.disabled=true;userAnswers[current]="__DOUBT__";stopTimer();advanceQuestion();};

  // ---------- RESULT ----------
  function showResult(){
    quizDiv.classList.add('hidden');resultDiv.classList.remove('hidden');
    gamesPlayed++;localStorage.setItem("gamesPlayed",String(gamesPlayed));
    const playedIds=JSON.parse(localStorage.getItem('playedIds')||'[]');
    const currentIds=questions.map(q=>q.id).filter(id=>id!=null);
    localStorage.setItem('playedIds',JSON.stringify([...new Set([...playedIds,...currentIds])].slice(-1000)));

    const totalHalu=questions.filter(q=>q.kind==="halu").length;
    const totalSafe=questions.length-totalHalu;
    const scoreTotal=score+vigilance;
    const scoreMax=questions.length;
    const validated=scoreTotal>=7;

    // TOKEN
    const tokenContainer=document.getElementById('tokenContainer');
    const tokenCanvas=document.getElementById('tokenCanvas');
    tokenContainer.classList.remove('hidden');

    const cssW=Math.min(500,tokenContainer.clientWidth-2);
    const w=cssW;const h=Math.round(w*0.48);
    const dpr=window.devicePixelRatio||1;
    tokenCanvas.style.width=w+"px";tokenCanvas.style.height=h+"px";
    tokenCanvas.width=Math.round(w*dpr);tokenCanvas.height=Math.round(h*dpr);
    const ctx=tokenCanvas.getContext("2d");
    ctx.setTransform(dpr,0,0,dpr,0,0);
    ctx.clearRect(0,0,w,h);

    // Fond dÃ©gradÃ© selon rÃ©sultat
    const grad=ctx.createLinearGradient(0,0,w,h);
    if(validated){
      grad.addColorStop(0,"#0f4c81");
      grad.addColorStop(1,"#1a7a5e");
    } else {
      grad.addColorStop(0,"#7f1d1d");
      grad.addColorStop(1,"#9a3412");
    }
    ctx.fillStyle=grad;ctx.fillRect(0,0,w,h);

    // Grille subtile
    ctx.strokeStyle='rgba(255,255,255,0.07)';ctx.lineWidth=1;
    for(let x=0;x<w;x+=36){ctx.beginPath();ctx.moveTo(x,0);ctx.lineTo(x,h);ctx.stroke();}
    for(let y=0;y<h;y+=36){ctx.beginPath();ctx.moveTo(0,y);ctx.lineTo(w,y);ctx.stroke();}

    // Textes
    ctx.fillStyle="#fff";ctx.textAlign="center";
    let fSize=Math.min(20,Math.floor(w*0.042));
    ctx.font=`bold ${fSize}px 'Press Start 2P'`;
    ctx.fillText(validated?"âœ… FORMATION VALIDÃ‰E":"âŒ FORMATION NON VALIDÃ‰E",w/2,Math.round(h*0.30));
    ctx.font=`bold ${Math.floor(fSize*1.1)}px 'Press Start 2P'`;
    ctx.fillText(`${scoreTotal} / ${scoreMax}`,w/2,Math.round(h*0.57));
    ctx.font=`13px 'DM Sans'`;ctx.fillStyle='rgba(255,255,255,0.6)';
    ctx.fillText("IQAI Test â€” AI Vigilance Platform",w/2,Math.round(h*0.82));

    // VALIDATION BADGE
    const badge=document.getElementById('validationBadge');
    badge.innerHTML=validated
      ? `<div class="validation-badge validated">
           <div class="vb-title">âœ… Formation validÃ©e</div>
           <div class="vb-sub">Score ${scoreTotal}/${scoreMax} â€” Seuil de validation atteint (7/10 minimum)</div>
         </div>`
      : `<div class="validation-badge not-validated">
           <div class="vb-title">âŒ Formation non validÃ©e</div>
           <div class="vb-sub">Score ${scoreTotal}/${scoreMax} â€” Score insuffisant. Seuil requis : 7/10 minimum.</div>
         </div>`;

    // SCORE CARDS
    scoreDetails.innerHTML=`
      <div class="score-card"><span class="sc-val">${score}/${totalSafe}</span><span class="sc-lbl">Questions classiques</span></div>
      <div class="score-card"><span class="sc-val">${vigilance}/${totalHalu}</span><span class="sc-lbl">Hallucinations dÃ©tectÃ©es</span></div>
    `;

    doubtBtn.classList.add("hidden");

    setTimeout(()=>{if(window.showNotifPopup)window.showNotifPopup();},2000);

    // REVIEW
    reviewContainer.innerHTML='<h3>Revue des questions</h3>';
    questions.forEach((q,i)=>{
      const user=userAnswers[i];const isDoubt=(user==="__DOUBT__");
      const ok=(q.kind==="halu"&&isDoubt)||(q.kind==="safe"&&user===q.answer);
      let statusHTML="";
      if(q.kind==="halu"){
        statusHTML=isDoubt
          ?`<div class="haluBanner ok">âœ… Hallucination dÃ©tectÃ©e â€” +1 pt</div>`
          :`<div class="haluBanner">âŒ BernÃ© par l'IA â€” 0 pt</div>`;
      } else {
        if(ok) statusHTML=`<div style="color:var(--success);font-weight:600;margin-top:8px;font-size:0.88em;">âœ… Bonne rÃ©ponse â€” +1 pt</div>`;
        else if(isDoubt) statusHTML=`<div style="color:var(--danger);font-weight:600;margin-top:8px;font-size:0.88em;">âŒ Doute injustifiÃ© â€” 0 pt</div>`;
        else statusHTML=`<div style="color:var(--danger);font-weight:600;margin-top:8px;font-size:0.88em;">âŒ Mauvaise rÃ©ponse â€” 0 pt</div>`;
      }
      const div=document.createElement('div');div.className="reviewItem";
      div.innerHTML=`
        <strong>Q${i+1} :</strong> ${q.q}<br>
        <span style="color:var(--muted);font-size:0.85em;">Votre rÃ©ponse :</span> <span class="answerTag ${ok?'ok':'bad'}">${isDoubt?"âš ï¸ Anomalie signalÃ©e":(user||"Temps Ã©coulÃ©")}</span><br>
        <span style="color:var(--muted);font-size:0.85em;">RÃ©ponse :</span> ${q.kind==="halu"?"IncohÃ©rence IA":q.answer}<br>
        <div style="margin-top:6px;font-size:0.84em;color:var(--muted);"><em>${q.explanation}</em></div>
        ${statusHTML}
      `;
      reviewContainer.appendChild(div);
    });
  }

  // ---------- START ----------
  async function startGame(){
    if(!checkCooldown()){
      const next=getNextPlayTime();const now=new Date();const diff=next-now;
      const h=Math.floor(diff/3600000);const m=Math.floor((diff%3600000)/60000);
      quizDiv.innerHTML=`<div class="cooldownMessage"><h2>â° Session dÃ©jÃ  complÃ©tÃ©e</h2><p>Prochaine session Ã  <strong>minuit</strong> (dans ${h}h ${m}min).</p><button onclick="location.reload()" style="margin-top:16px;padding:10px 24px;background:var(--accent);color:#fff;border:none;border-radius:8px;cursor:pointer;font-weight:700;">RafraÃ®chir</button></div>`;
      return;
    }
    clearError();resultDiv.classList.add('hidden');quizDiv.classList.remove('hidden');reviewContainer.innerHTML="";
    current=0;score=0;vigilance=0;userAnswers=new Array(10).fill(null);updateProgress();
    nextBtn.disabled=true;optionsContainer.innerHTML="";
    questionContainer.innerHTML=`<div class="question">GÃ©nÃ©ration du quiz en coursâ€¦</div>`;
    doubtBtn.classList.add("hidden");doubtBtn.disabled=false;
    try{await loadQuestions();showQuestion();}
    catch(e){stopTimer();timerDisplay.classList.add("hidden");showError("Erreur : "+(e?.message||e));questionContainer.innerHTML='<div class="question">Impossible de charger le quiz.</div>';nextBtn.disabled=true;}
  }

  startBtn.onclick=()=>{
    window.quizStartTime=Date.now();
    startScreen.classList.add("hidden");gameContainer.classList.remove("hidden");
    const ms=animateTitle({letterDelayMs:140,initialDelayMs:80});
    cursorTimeoutId=setTimeout(()=>showCursorBlink(),ms+120);
    try{bootSound.pause();bootSound.currentTime=0;bootSound.load();const p=bootSound.play();if(p&&typeof p.catch==="function")p.catch(()=>{});bootSound.onended=()=>showCursorBlink();}catch(e){}
    startGame();
  };

  // ---------- NOTIF ----------
  function showNotifPopup(){
    if(window.OneSignalDeferred){OneSignalDeferred.push(async function(O){try{const sup=await O.Notifications.isPushSupported();if(sup&&O.Notifications.permission!=="granted"){document.getElementById('notifPopup').classList.remove('hidden');}}catch(e){}});}
  }
  window.showNotifPopup=showNotifPopup;
  document.addEventListener('DOMContentLoaded',()=>{
    const popup=document.getElementById('notifPopup');
    document.getElementById('notifAccept').onclick=async()=>{popup.classList.add('hidden');if(window.OneSignalDeferred){OneSignalDeferred.push(async function(O){try{await O.Notifications.requestPermission();await O.User.addTag("status","joueur_actif");}catch(e){}});}};
    document.getElementById('notifDecline').onclick=()=>popup.classList.add('hidden');
  });
</script>
</body>
</html>
