<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>IQAI Test â€” AI Vigilance Platform</title>
<link rel="icon" href="data:,">

<link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=DM+Sans:ital,wght@0,400;0,500;0,600;0,700;0,800;1,400&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">

<script src="https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js" defer></script>
<script>
  window.OneSignalDeferred = window.OneSignalDeferred || [];
  OneSignalDeferred.push(async function(OneSignal) {
    await OneSignal.init({
      appId: "dc73bf96-dbcf-4498-ab4d-5639c66b16ea",
      safari_web_id: "web.onesignal.auto.10309993-875c-4384-934c-26792f444f2b",
      notifyButton: { enable: true },
      allowLocalhostAsSecureOrigin: true,
    });
  });
</script>

<style>
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

  :root {
    --bg:       #eef2f9;
    --surface:  #ffffff;
    --surface2: #f4f7fc;
    --border:   rgba(29,111,229,0.10);
    --border2:  rgba(29,111,229,0.18);
    --text:     #0f1f3d;
    --muted:    #5e718a;
    --accent:   #1d6fe5;
    --accent2:  #00b899;
    --danger:   #dc2626;
    --success:  #16a34a;

    --title-font: 'Press Start 2P', monospace;
    --body-font:  'DM Sans', system-ui, sans-serif;
    --mono-font:  'DM Mono', monospace;
  }

  body {
    min-height: 100vh;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: flex-start;
    background: var(--bg);
    padding: 36px 16px 56px;
    font-family: var(--body-font);
    color: var(--text);
    position: relative;
  }

  /* Fond : grille + gradient radial centrÃ© */
  body::before {
    content: '';
    position: fixed; inset: 0; z-index: 0;
    background:
      radial-gradient(ellipse 70% 55% at 50% 0%, rgba(29,111,229,0.10) 0%, transparent 70%),
      linear-gradient(rgba(29,111,229,0.055) 1px, transparent 1px),
      linear-gradient(90deg, rgba(29,111,229,0.055) 1px, transparent 1px);
    background-size: auto, 44px 44px, 44px 44px;
    pointer-events: none;
  }

  /* â”€â”€ HEADER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .site-header {
    width: 100%;
    max-width: 600px;
    display: flex;
    flex-direction: column;
    align-items: center;
    margin-bottom: 28px;
    position: relative;
    z-index: 1;
  }

  /* Pill badge "LIVE" */
  .live-badge {
    display: inline-flex;
    align-items: center;
    gap: 7px;
    background: rgba(29,111,229,0.09);
    border: 1px solid rgba(29,111,229,0.22);
    border-radius: 999px;
    padding: 5px 14px 5px 9px;
    margin-bottom: 18px;
    font-family: var(--body-font);
    font-size: 0.73em;
    font-weight: 700;
    color: var(--accent);
    letter-spacing: 0.6px;
    text-transform: uppercase;
  }
  .live-badge .dot {
    width: 7px; height: 7px; border-radius: 50%;
    background: var(--accent2);
    animation: pulse 2.2s ease-in-out infinite;
  }
  @keyframes pulse {
    0%,100% { opacity:1; transform:scale(1); }
    50%      { opacity:0.4; transform:scale(0.7); }
  }

  /* Logo IQAI TEST â€” toujours visible, mÃªme avant le start */
  .logo-wrap {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 10px;
    margin-bottom: 6px;
  }
  .logo-title {
    font-family: var(--title-font);
    font-size: clamp(1.35em, 3.8vw, 1.9em);
    line-height: 1.2;
    text-align: center;
    letter-spacing: 1px;
    color: var(--text);
  }
  .logo-title span { display: inline-block; }
  .title-sep { margin: 0 10px; opacity: 0; color: var(--muted); }
  .title-sep.cursor-on { opacity:1; animation: caretBlink 1.7s steps(1,end) infinite; }
  @keyframes caretBlink { 0%,49%{opacity:1;} 50%,100%{opacity:0;} }

  .tagline {
    font-size: 0.83em;
    font-weight: 600;
    color: var(--muted);
    letter-spacing: 1.2px;
    text-transform: uppercase;
    text-align: center;
  }

  /* â”€â”€ CARD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .container {
    max-width: 580px;
    width: 100%;
    background: var(--surface);
    border: 1px solid var(--border2);
    border-radius: 20px;
    padding: 30px;
    box-shadow:
      0 1px 0 rgba(255,255,255,0.9) inset,
      0 4px 6px rgba(29,111,229,0.04),
      0 24px 56px rgba(29,111,229,0.10);
    position: relative;
    z-index: 1;
  }

  /* â”€â”€ START SCREEN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .section-label {
    font-size: 0.72em;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 1.2px;
    color: var(--accent);
    margin-bottom: 10px;
  }

  #startScreen .intro-text {
    text-align: center;
    margin-bottom: 26px;
    padding-bottom: 22px;
    border-bottom: 1px solid var(--border);
  }
  #startScreen .intro-text h2 {
    font-size: 1.15em;
    font-weight: 800;
    margin-bottom: 10px;
    color: var(--text);
    line-height: 1.35;
  }
  #startScreen .intro-text p {
    font-size: 0.9em;
    color: var(--muted);
    line-height: 1.65;
  }

  .stat-row {
    display: grid;
    grid-template-columns: 1fr 1fr 1fr;
    gap: 10px;
    margin-bottom: 22px;
  }
  .stat-cell {
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 16px 10px;
    text-align: center;
    position: relative;
    overflow: hidden;
  }
  .stat-cell::before {
    content:'';
    position:absolute; top:0; left:0; right:0; height:3px;
    background: linear-gradient(90deg, var(--accent), var(--accent2));
    border-radius: 12px 12px 0 0;
  }
  .stat-cell .stat-val {
    font-family: var(--mono-font);
    font-size: 1.35em;
    font-weight: 500;
    color: var(--accent);
    display: block;
    margin-bottom: 5px;
  }
  .stat-cell .stat-lbl {
    font-size: 0.71em;
    font-weight: 600;
    color: var(--muted);
    line-height: 1.3;
  }

  .rules-block {
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 14px;
    padding: 18px;
    margin-bottom: 26px;
    font-size: 0.88em;
    color: var(--muted);
  }
  .rules-block .rule {
    display: flex; align-items: flex-start; gap: 10px;
    padding: 7px 0;
    border-bottom: 1px solid var(--border);
    line-height: 1.5;
  }
  .rules-block .rule:last-child { border-bottom: none; padding-bottom: 0; }
  .rules-block .rule:first-child { padding-top: 0; }
  .rules-block strong { color: var(--text); }

  #startBtn {
    width: 100%;
    padding: 17px;
    font-size: 1em;
    font-weight: 700;
    border: none;
    border-radius: 13px;
    background: linear-gradient(135deg, #1d6fe5 0%, #1558c0 100%);
    color: #fff;
    cursor: pointer;
    transition: filter 0.15s, transform 0.1s, box-shadow 0.15s;
    font-family: var(--body-font);
    letter-spacing: 0.3px;
    box-shadow: 0 4px 20px rgba(29,111,229,0.35), 0 1px 0 rgba(255,255,255,0.15) inset;
  }
  #startBtn:hover  { filter: brightness(1.08); box-shadow: 0 6px 28px rgba(29,111,229,0.45); }
  #startBtn:active { transform: translateY(1px); }

  /* â”€â”€ PROGRESS BAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .progress-wrap {
    display: flex; align-items: center; gap: 12px; margin-bottom: 22px;
  }
  .progress-track {
    flex: 1; height: 5px;
    background: var(--border2);
    border-radius: 99px; overflow: hidden;
  }
  .progress-fill {
    height: 100%;
    background: linear-gradient(90deg, var(--accent), var(--accent2));
    border-radius: 99px;
    transition: width 0.4s cubic-bezier(.4,0,.2,1);
    width: 0%;
  }
  .progress-label {
    font-family: var(--mono-font);
    font-size: 0.78em;
    color: var(--muted);
    white-space: nowrap;
  }

  /* â”€â”€ TIMER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  #timerLine { display: flex; justify-content: flex-end; margin-bottom: 6px; }
  #timerDisplay {
    font-family: var(--mono-font);
    font-size: 0.8em;
    color: var(--muted);
    background: var(--surface2);
    border: 1px solid var(--border);
    padding: 4px 13px;
    border-radius: 999px;
    transition: color 0.3s, border-color 0.3s, background 0.3s;
  }
  #timerDisplay.timer-urgent {
    color: var(--danger);
    border-color: rgba(220,38,38,0.3);
    background: rgba(220,38,38,0.05);
  }

  /* â”€â”€ QUESTION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .q-num {
    font-family: var(--mono-font);
    color: var(--accent);
    font-size: 0.74em;
    display: block;
    margin-bottom: 8px;
    letter-spacing: 0.4px;
  }
  .question {
    font-size: 1.05em;
    font-weight: 700;
    line-height: 1.5;
    margin-bottom: 20px;
    color: var(--text);
  }

  /* â”€â”€ OPTIONS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .options button {
    display: flex; align-items: center; gap: 13px;
    width: 100%; padding: 14px 16px; margin-bottom: 9px;
    border: 1.5px solid var(--border2);
    border-radius: 11px;
    background: var(--surface2);
    color: var(--text);
    cursor: pointer;
    font-weight: 500;
    font-family: var(--body-font);
    font-size: 0.94em;
    text-align: left;
    transition: border-color 0.15s, background 0.15s, box-shadow 0.15s;
  }
  .options button:hover {
    border-color: var(--accent);
    background: rgba(29,111,229,0.04);
    box-shadow: 0 2px 12px rgba(29,111,229,0.08);
  }
  .options button.selected {
    border-color: var(--accent);
    background: rgba(29,111,229,0.07);
    box-shadow: 0 2px 12px rgba(29,111,229,0.12);
  }
  .opt-check {
    width: 21px; height: 21px; border-radius: 7px;
    border: 1.5px solid rgba(29,111,229,0.25);
    display: flex; align-items: center; justify-content: center;
    flex-shrink: 0;
    font-size: 0.78em;
    font-weight: 900;
    transition: border-color 0.15s, background 0.15s;
    color: transparent;
  }
  .options button.selected .opt-check {
    border-color: var(--accent);
    background: var(--accent);
    color: #fff;
  }

  /* â”€â”€ ACTION BUTTONS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
 #nextBtn {
    width: 100%; padding: 14px; margin-top: 10px;
    border: none;
    border-radius: 11px;
    background: var(--accent);
    color: #fff;
    cursor: pointer;
    font-weight: 700;
    font-family: var(--body-font);
    font-size: 0.94em;
    box-shadow: 0 3px 14px rgba(29,111,229,0.28);
    transition: filter 0.15s, box-shadow 0.15s;
  }
  #nextBtn:not(:disabled):hover { filter: brightness(1.08); box-shadow: 0 4px 20px rgba(29,111,229,0.38); }
  #nextBtn:disabled { opacity: 0.32; cursor: not-allowed; background: var(--muted); box-shadow: none; }

  #doubtBtn {
    width: 100%; padding: 15px; margin-top: 10px;
    border-radius: 11px;
    border: 1.5px solid rgba(220,38,38,0.35);
    background: rgba(220,38,38,0.04);
    color: var(--danger);
    font-weight: 700;
    font-size: 0.92em;
    cursor: pointer;
    font-family: var(--body-font);
    transition: background 0.15s, border-color 0.15s, box-shadow 0.15s;
    letter-spacing: 0.2px;
  }
  #doubtBtn:hover:not(:disabled) {
    background: rgba(220,38,38,0.09);
    border-color: var(--danger);
    box-shadow: 0 2px 12px rgba(220,38,38,0.12);
  }
  #doubtBtn:disabled { opacity: 0.32; cursor: not-allowed; }

  /* â”€â”€ ERROR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .errorBox {
    margin-top:10px;padding:12px;border-radius:10px;
    background:rgba(220,38,38,0.05);
    border:1px solid rgba(220,38,38,0.2);
    color:var(--danger);font-weight:600;font-size:0.9em;
  }

  /* â”€â”€ RESULT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */

  /* TOKEN */
  #tokenContainer {
    width:100%; margin: 0 auto 22px;
    border-radius: 14px; overflow: hidden;
    border: 1px solid var(--border2);
    box-shadow: 0 6px 28px rgba(0,0,0,0.10);
  }
  #tokenCanvas { display:block; width:100%; height:auto; }

  /* VALIDATION BADGE */
  .validation-badge {
    display: flex; align-items: center; gap: 14px;
    padding: 18px 20px;
    border-radius: 14px;
    margin-bottom: 20px;
    border: 1.5px solid;
  }
  .validation-badge.validated {
    background: rgba(22,163,74,0.05);
    border-color: rgba(22,163,74,0.25);
  }
  .validation-badge.not-validated {
    background: rgba(220,38,38,0.05);
    border-color: rgba(220,38,38,0.22);
  }
  .vb-icon { font-size: 1.6em; flex-shrink: 0; }
  .vb-body { flex: 1; }
  .vb-title {
    font-size: 1em;
    font-weight: 800;
    margin-bottom: 3px;
  }
  .validation-badge.validated .vb-title { color: var(--success); }
  .validation-badge.not-validated .vb-title { color: var(--danger); }
  .vb-sub { font-size: 0.83em; color: var(--muted); line-height: 1.45; }

  /* SCORE CARDS */
  #scoreDetails {
    display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 18px;
  }
  .score-card {
    background: var(--surface2); border: 1px solid var(--border);
    border-radius: 12px; padding: 16px; text-align: center;
    position: relative; overflow: hidden;
  }
  .score-card::before {
    content:''; position:absolute; top:0; left:0; right:0; height:3px;
    background: linear-gradient(90deg, var(--accent), var(--accent2));
  }
  .score-card .sc-val {
    font-family: var(--mono-font); font-size: 1.7em; font-weight: 500;
    color: var(--accent); display: block; margin-bottom: 4px;
  }
  .score-card .sc-lbl { font-size: 0.77em; font-weight:600; color: var(--muted); }

  /* HOW IT WORKS */
  #howItWorks {
    margin-top:16px; padding:16px;
    background: var(--surface2); border:1px solid var(--border);
    border-radius:12px; font-size:0.84em; line-height:1.85; color:var(--muted);
  }
  #howItWorks strong { color:var(--text); font-weight:700; display:block; margin-bottom:5px; }

  /* REVIEW */
  #reviewContainer { margin-top: 22px; }
  #reviewContainer h3 {
    font-size: 0.78em; font-weight: 700; text-transform: uppercase;
    letter-spacing: 1.1px; color: var(--muted); margin-bottom: 12px;
  }
  .reviewItem {
    padding: 14px 16px; border: 1px solid var(--border);
    border-radius: 12px; margin-bottom: 9px;
    background: var(--surface2); line-height: 1.55;
    font-size: 0.88em; color: var(--text);
  }
  .haluBanner {
    margin-top:8px;padding:8px 12px;border-radius:8px;
    font-weight:600;font-size:0.88em;line-height:1.4;
    background:rgba(220,38,38,0.06);
    border:1px solid rgba(220,38,38,0.2);
    color:var(--danger);
  }
  .haluBanner.ok {
    background:rgba(22,163,74,0.06);
    border-color:rgba(22,163,74,0.2);
    color:var(--success);
  }
  .answerTag {
    display:inline-block;padding:2px 9px;border-radius:6px;
    font-weight:600;font-size:0.9em;
  }
  .answerTag.ok  { background:rgba(22,163,74,0.09); border:1px solid rgba(22,163,74,0.25); color:var(--success); }
  .answerTag.bad { background:rgba(220,38,38,0.09); border:1px solid rgba(220,38,38,0.22); color:var(--danger); }

  /* COOLDOWN */
  .cooldownMessage { text-align:center; padding:28px 10px; }
  .cooldownMessage h2 { font-size:1.15em; margin-bottom:12px; color:var(--text); }
  .cooldownMessage p  { font-size:0.9em; line-height:1.6; color:var(--muted); }

  /* NOTIF POPUP */
  .notifPopup { position:fixed;inset:0;background:rgba(15,31,61,0.55);display:flex;align-items:center;justify-content:center;z-index:9999;padding:20px;backdrop-filter:blur(5px); }
  .notifPopup.hidden { display:none; }
  .notifPopupContent { background:var(--surface);border:1px solid var(--border2);border-radius:20px;padding:32px;max-width:420px;width:100%;text-align:center;box-shadow:0 24px 64px rgba(0,0,0,0.15);animation:popupSlide 0.3s ease; }
  @keyframes popupSlide { from{transform:translateY(-20px);opacity:0;} to{transform:translateY(0);opacity:1;} }
  .notifPopup h2 { font-size:1.1em;font-weight:800;margin-bottom:10px;color:var(--text); }
  .notifPopup p  { font-size:0.9em;line-height:1.6;color:var(--muted);margin-bottom:22px; }
  .notifPopup .btnPrimary { width:100%;padding:13px;border:none;border-radius:11px;background:var(--accent);color:#fff;font-weight:700;font-size:0.95em;cursor:pointer;margin-bottom:10px;font-family:var(--body-font);transition:filter 0.15s; }
  .notifPopup .btnPrimary:hover { filter:brightness(1.08); }
  .notifPopup .btnSecondary { background:none;border:none;color:var(--muted);font-size:0.85em;cursor:pointer;padding:8px;font-family:var(--body-font); }
  .notifPopup .btnSecondary:hover { color:var(--text); }

  .hidden { display: none; }

  @media (max-width: 420px) {
    .logo-title { font-size: 1.2em; }
    .stat-row { grid-template-columns: 1fr 1fr; }
    .stat-row .stat-cell:last-child { grid-column: span 2; }
  }
</style>
</head>

<body>

  <!-- HEADER : logo toujours visible -->
  <div class="site-header">
    <div class="live-badge">
      <span class="dot"></span>
      AI Vigilance Platform
    </div>
    <div class="logo-wrap">
      <div class="logo-title" id="title"></div>
    </div>
    <p class="tagline">Votre formation de vigilance IA</p>
  </div>

  <!-- START SCREEN -->
  <div id="startScreen" class="container">
    <div class="intro-text">
      <p class="section-label">Ã€ propos de cette Ã©valuation</p>
      <h2>Mesurez la capacitÃ© de vos Ã©quipes Ã  dÃ©tecter les erreurs de l'IA</h2>
      <p>Cette session comprend 10 questions gÃ©nÃ©rÃ©es par intelligence artificielle. Certaines sont exactes, d'autres contiennent des erreurs dÃ©libÃ©rÃ©es. Votre mission : distinguer l'information fiable des hallucinations.</p>
    </div>

    <div class="stat-row">
      <div class="stat-cell">
        <span class="stat-val">10</span>
        <span class="stat-lbl">Questions par session</span>
      </div>
      <div class="stat-cell">
        <span class="stat-val">30s</span>
        <span class="stat-lbl">Temps par question</span>
      </div>
      <div class="stat-cell">
        <span class="stat-val">7/10</span>
        <span class="stat-lbl">Seuil de validation</span>
      </div>
    </div>

    <div class="rules-block">
      <p class="section-label" style="margin-bottom:14px;">RÃ¨gles de scoring</p>
      <div class="rule"><span>âœ…</span><span>RÃ©ponse correcte Ã  une question fiable â†’ <strong>+1 point</strong></span></div>
      <div class="rule"><span>âœ…</span><span>Erreur IA identifiÃ©e via le bouton "Signaler une anomalie" â†’ <strong>+1 point</strong></span></div>
      <div class="rule"><span>âŒ</span><span>RÃ©ponse incorrecte ou erreur IA non dÃ©tectÃ©e â†’ <strong>0 point</strong></span></div>
    </div>

    <button id="startBtn">â–¶ Lancer l'Ã©valuation</button>
  </div>

  <!-- GAME CONTAINER -->
  <div class="container hidden" id="gameContainer">
    <div id="quiz">
      <div class="progress-wrap">
        <div class="progress-track"><div class="progress-fill" id="progressFill"></div></div>
        <div class="progress-label" id="progressLabel">0 / 10</div>
      </div>
      <div id="timerLine">
        <div id="timerDisplay" class="hidden">â± 30</div>
      </div>
      <div id="questionContainer"></div>
      <div class="options" id="optionsContainer"></div>
      <button id="nextBtn" disabled>Suivant â†’</button>
      <button id="doubtBtn" class="hidden">âš ï¸ Signaler une anomalie IA</button>
      <div id="errorContainer" class="hidden"></div>
    </div>

    <div id="result" class="hidden">

      <!-- TOKEN CANVAS -->
      <div id="tokenContainer" class="hidden">
        <canvas id="tokenCanvas" width="500" height="250"></canvas>
      </div>

      <!-- VALIDATION BADGE -->
      <div id="validationBadge"></div>

      <!-- SCORE CARDS -->
      <div id="scoreDetails"></div>

      <!-- HOW IT WORKS -->
      <div id="howItWorks">
        <strong>ğŸ“Š DÃ©tail du calcul</strong>
        âœ… Bonne rÃ©ponse (question fiable) = +1 pt &nbsp;|&nbsp; âœ… Anomalie IA dÃ©tectÃ©e = +1 pt<br>
        âŒ RÃ©ponse incorrecte = 0 pt &nbsp;|&nbsp; âŒ Anomalie IA non dÃ©tectÃ©e = 0 pt
      </div>

      <!-- REVIEW DES QUESTIONS -->
      <div id="reviewContainer"></div>

    </div>
  </div>

  <!-- NOTIF POPUP -->
  <div id="notifPopup" class="notifPopup hidden">
    <div class="notifPopupContent">
      <h2>ğŸ”” Rappel quotidien</h2>
      <p>Activez les notifications pour recevoir un rappel chaque jour et maintenir votre niveau de vigilance IA.</p>
      <button id="notifAccept" class="btnPrimary">Activer les rappels</button>
      <button id="notifDecline" class="btnSecondary">Plus tard</button>
    </div>
  </div>

<!-- ==================== JS ==================== -->
<script>
  // ---------- TITLE ANIMATION ----------
  const colors = ["#1d6fe5","#00b899","#16a34a","#f59e0b","#1d6fe5","#dc2626"];
  const titleContainer = document.getElementById("title");
  const parts = ["IQAI","Test"];
  let cursorSepEl=null, cursorTimeoutId=null, hasShownCursor=false;

  function clearTitle(){ titleContainer.innerHTML=""; cursorSepEl=null; hasShownCursor=false; if(cursorTimeoutId){clearTimeout(cursorTimeoutId);cursorTimeoutId=null;} }
  function showCursorBlink(){ if(hasShownCursor)return; if(cursorSepEl){cursorSepEl.classList.add("cursor-on");hasShownCursor=true;} }

  function animateTitle({ letterDelayMs=140, initialDelayMs=80 }={}){
    clearTitle();
    const spans=[]; let colorIndex=0;
    function addColoredText(text){
      text.split("").forEach((c,i)=>{
        const s=document.createElement("span");
        s.textContent=c; s.style.opacity="0"; s.style.transform="scale(0.8)";
        s.style.transition="opacity 180ms ease, transform 180ms ease";
        s.style.color=colors[(colorIndex+i)%colors.length];
        spans.push(s); titleContainer.appendChild(s);
      }); colorIndex+=text.length;
    }
    addColoredText(parts[0]);
    cursorSepEl=document.createElement("span"); cursorSepEl.className="title-sep"; cursorSepEl.textContent="|";
    titleContainer.appendChild(cursorSepEl);
    addColoredText(parts[1]);
    spans.forEach((s,i)=>{ setTimeout(()=>{ s.style.opacity="1"; s.style.transform="scale(1)"; }, initialDelayMs+(i*letterDelayMs)); });
    return initialDelayMs+(spans.length*letterDelayMs)+220;
  }

  // Lancer l'animation du titre dÃ¨s le chargement de la page
  window.addEventListener('DOMContentLoaded', () => {
    const ms = animateTitle({ letterDelayMs: 140, initialDelayMs: 80 });
    cursorTimeoutId = setTimeout(() => showCursorBlink(), ms + 120);
  });

  // ---------- STATE ----------
  const API_URL = "https://iqai-backend-git-saas-iqai-raphfs-projects.vercel.app/api/quiz";
  let questions=[], current=0, score=0, vigilance=0, userAnswers=[];
  const QUESTION_TIME = 30;
  let timeLeft=QUESTION_TIME, timerId=null;

  // ---------- DOM ----------
  const questionContainer = document.getElementById('questionContainer');
  const optionsContainer  = document.getElementById('optionsContainer');
  const nextBtn           = document.getElementById('nextBtn');
  const doubtBtn          = document.getElementById('doubtBtn');
  const quizDiv           = document.getElementById('quiz');
  const resultDiv         = document.getElementById('result');
  const scoreDetails      = document.getElementById('scoreDetails');
  const reviewContainer   = document.getElementById('reviewContainer');
  const errorContainer    = document.getElementById('errorContainer');
  const timerDisplay      = document.getElementById("timerDisplay");
  const startScreen       = document.getElementById("startScreen");
  const startBtn          = document.getElementById("startBtn");
  const gameContainer     = document.getElementById("gameContainer");
  const progressFill      = document.getElementById("progressFill");
  const progressLabel     = document.getElementById("progressLabel");

  let gamesPlayed = parseInt(localStorage.getItem("gamesPlayed")||"0", 10);

  function updateProgress(){
    const pct=(current/(questions.length||10))*100;
    progressFill.style.width=pct+"%";
    progressLabel.textContent=current+" / "+(questions.length||10);
  }

  // ---------- COOLDOWN ----------
  function checkCooldown(){ const d=localStorage.getItem("lastPlayedDate"); if(!d)return true; return new Date(d).toDateString()!==new Date().toDateString(); }
  function setLastPlayed(){ localStorage.setItem("lastPlayedDate", new Date().toISOString()); }
  function getNextPlayTime(){ const t=new Date(); t.setDate(t.getDate()+1); t.setHours(0,0,0,0); return t; }

  // ---------- HELPERS ----------
  function showError(msg){ errorContainer.classList.remove('hidden'); errorContainer.className="errorBox"; errorContainer.textContent=msg; }
  function clearError(){ errorContainer.classList.add('hidden'); errorContainer.className=""; errorContainer.textContent=""; }

  function normalizeQuiz(raw){
    if(!Array.isArray(raw))return null;
    const arr=raw.slice(0,10).map(x=>({ id:x.id, q:String(x.q??""), options:Array.isArray(x.options)?x.options.map(String).slice(0,4):[], answer:String(x.answer??""), explanation:String(x.explanation??""), kind:String(x.kind??"safe") })).filter(x=>x.q&&x.options.length===4&&x.answer);
    return (arr.length===10)?arr:null;
  }

  async function fetchWithTimeout(url,options={},ms=30000){
    const c=new AbortController(); const id=setTimeout(()=>c.abort(),ms);
    try{ return await fetch(url,{...options,signal:c.signal}); } finally{ clearTimeout(id); }
  }

  async function loadQuestions(){
    const playedIds=JSON.parse(localStorage.getItem('playedIds')||'[]');
    const opts={ method:"POST", headers:{"Content-Type":"application/json"}, cache:"no-store", body:JSON.stringify({playedIds}) };
    let res;
    try{ res=await fetchWithTimeout(API_URL,opts,30000); } catch(e){ res=await fetchWithTimeout(API_URL,opts,35000); }
    if(!res||!res.ok) throw new Error("Erreur serveur (HTTP "+(res?res.status:"â€”")+")");
    const raw=await res.json();
    const quiz=normalizeQuiz(raw);
    if(!quiz) throw new Error("Format de quiz invalide.");
    questions=quiz;
  }

  // ---------- TIMER ----------
  function stopTimer(){ if(timerId){clearInterval(timerId);timerId=null;} }
  function startTimer(){
    stopTimer(); timeLeft=QUESTION_TIME;
    timerDisplay.classList.remove("hidden");
    timerDisplay.textContent=`â± ${timeLeft}`;
    timerDisplay.classList.remove("timer-urgent");
    timerId=setInterval(()=>{
      timeLeft--;
      timerDisplay.textContent=`â± ${timeLeft}`;
      if(timeLeft<=10) timerDisplay.classList.add("timer-urgent");
      else timerDisplay.classList.remove("timer-urgent");
      if(timeLeft<=0){ stopTimer(); advanceQuestion(); }
    },1000);
  }

  // ---------- QUIZ UI ----------
  function showQuestion(){
    clearError(); updateProgress();
    const qObj=questions[current];
    questionContainer.innerHTML=`<div class="question"><span class="q-num">Question ${current+1} sur ${questions.length}</span>${qObj.q}</div>`;
    optionsContainer.innerHTML='';
    nextBtn.disabled=(userAnswers[current]==null);
    doubtBtn.classList.remove("hidden"); doubtBtn.textContent="âš ï¸ Signaler une anomalie IA"; doubtBtn.disabled=false;

    qObj.options.forEach(opt=>{
      const btn=document.createElement('button');
      const check=document.createElement('span'); check.className='opt-check';
      btn.appendChild(check);
      const label=document.createElement('span'); label.textContent=opt;
      btn.appendChild(label);
      if(userAnswers[current]===opt){ btn.classList.add('selected'); check.textContent='âœ“'; }
      btn.onclick=()=>{
        userAnswers[current]=opt;
        Array.from(optionsContainer.children).forEach(b=>{
          const c=b.querySelector('.opt-check');
          const sel=b.querySelector('span:last-child').textContent===opt;
          b.classList.toggle('selected',sel); c.textContent=sel?'âœ“':'';
        });
        nextBtn.disabled=false;
      };
      optionsContainer.appendChild(btn);
    });
    startTimer();
  }

  function advanceQuestion(){
    const qObj=questions[current]; const selected=userAnswers[current]; const isDoubt=(selected==="__DOUBT__");
    if(qObj.kind==="halu"){ if(isDoubt) vigilance+=1; }
    else { if(!isDoubt && selected===qObj.answer) score+=1; }
    current++; updateProgress();
    if(current<questions.length){ showQuestion(); }
    else { stopTimer(); timerDisplay.classList.add("hidden"); setLastPlayed(); showResult(); }
  }

  nextBtn.onclick=()=>{ stopTimer(); advanceQuestion(); };
  doubtBtn.onclick=()=>{ doubtBtn.disabled=true; userAnswers[current]="__DOUBT__"; stopTimer(); advanceQuestion(); };

  // ---------- RESULT ----------
  function showResult(){
    quizDiv.classList.add('hidden'); resultDiv.classList.remove('hidden');
    gamesPlayed++;
    localStorage.setItem("gamesPlayed", String(gamesPlayed));
    const playedIds=JSON.parse(localStorage.getItem('playedIds')||'[]');
    const currentIds=questions.map(q=>q.id).filter(id=>id!=null);
    localStorage.setItem('playedIds', JSON.stringify([...new Set([...playedIds,...currentIds])].slice(-1000)));

    const totalHalu=questions.filter(q=>q.kind==="halu").length;
    const totalSafe=questions.length-totalHalu;
    const scoreTotal=score+vigilance;
    const scoreMax=questions.length;
    const validated=(scoreTotal>=7);

    // â”€â”€ TOKEN CANVAS â”€â”€
    const tokenContainer=document.getElementById('tokenContainer');
    const tokenCanvas=document.getElementById('tokenCanvas');
    tokenContainer.classList.remove('hidden');

    const cssW=Math.min(500, tokenContainer.clientWidth-2);
    const w=cssW; const h=Math.round(w*0.46);
    const dpr=window.devicePixelRatio||1;
    tokenCanvas.style.width=w+"px"; tokenCanvas.style.height=h+"px";
    tokenCanvas.width=Math.round(w*dpr); tokenCanvas.height=Math.round(h*dpr);
    const ctx=tokenCanvas.getContext("2d");
    ctx.setTransform(dpr,0,0,dpr,0,0);
    ctx.clearRect(0,0,w,h);

    // Fond
    const grad=ctx.createLinearGradient(0,0,w,h);
    if(validated){ grad.addColorStop(0,"#0f3460"); grad.addColorStop(1,"#0d6e5a"); }
    else          { grad.addColorStop(0,"#6b1a1a"); grad.addColorStop(1,"#7c2d12"); }
    ctx.fillStyle=grad; ctx.fillRect(0,0,w,h);

    // Grille subtile
    ctx.strokeStyle='rgba(255,255,255,0.06)'; ctx.lineWidth=1;
    for(let x=0;x<w;x+=38){ctx.beginPath();ctx.moveTo(x,0);ctx.lineTo(x,h);ctx.stroke();}
    for(let y=0;y<h;y+=38){ctx.beginPath();ctx.moveTo(0,y);ctx.lineTo(w,y);ctx.stroke();}

    // Ligne de sÃ©paration dÃ©corative
    ctx.strokeStyle='rgba(255,255,255,0.12)'; ctx.lineWidth=1;
    ctx.beginPath(); ctx.moveTo(w*0.08, h*0.72); ctx.lineTo(w*0.92, h*0.72); ctx.stroke();

    // Textes
    ctx.textAlign="center";
    let fSize=Math.min(18, Math.floor(w*0.038));

    ctx.fillStyle="rgba(255,255,255,0.55)";
    ctx.font=`500 12px 'DM Sans'`;
    ctx.fillText("IQAI TEST â€” AI VIGILANCE PLATFORM", w/2, Math.round(h*0.18));

    ctx.fillStyle="#ffffff";
    ctx.font=`bold ${fSize}px 'Press Start 2P'`;
    ctx.fillText(validated ? "âœ… FORMATION VALIDÃ‰E" : "âŒ NON VALIDÃ‰E", w/2, Math.round(h*0.42));

    ctx.font=`bold ${Math.floor(fSize*1.15)}px 'Press Start 2P'`;
    ctx.fillText(`${scoreTotal} / ${scoreMax}`, w/2, Math.round(h*0.62));

    ctx.fillStyle="rgba(255,255,255,0.50)";
    ctx.font=`500 11px 'DM Sans'`;
    ctx.fillText(`Score obtenu â€” Seuil requis : 7/10`, w/2, Math.round(h*0.84));

    // â”€â”€ VALIDATION BADGE â”€â”€
    const badge=document.getElementById('validationBadge');
    if(validated){
      badge.innerHTML=`
        <div class="validation-badge validated">
          <span class="vb-icon">âœ…</span>
          <div class="vb-body">
            <div class="vb-title">Formation validÃ©e</div>
            <div class="vb-sub">Score obtenu : ${scoreTotal}/${scoreMax} â€” Le seuil de validation de 7/10 est atteint.</div>
          </div>
        </div>`;
    } else {
      badge.innerHTML=`
        <div class="validation-badge not-validated">
          <span class="vb-icon">âŒ</span>
          <div class="vb-body">
            <div class="vb-title">Formation non validÃ©e</div>
            <div class="vb-sub">Score obtenu : ${scoreTotal}/${scoreMax} â€” Score insuffisant. Le seuil requis est de 7/10 minimum.</div>
          </div>
        </div>`;
    }

    // â”€â”€ SCORE CARDS â”€â”€
    scoreDetails.innerHTML=`
      <div class="score-card">
        <span class="sc-val">${score}/${totalSafe}</span>
        <span class="sc-lbl">Questions culturelles</span>
      </div>
      <div class="score-card">
        <span class="sc-val">${vigilance}/${totalHalu}</span>
        <span class="sc-lbl">Anomalies IA dÃ©tectÃ©es</span>
      </div>
    `;

    doubtBtn.classList.add("hidden");
    setTimeout(()=>{ if(window.showNotifPopup) window.showNotifPopup(); }, 2000);

    // â”€â”€ REVIEW â”€â”€
    reviewContainer.innerHTML='<h3>Revue dÃ©taillÃ©e des questions</h3>';
    questions.forEach((q,i)=>{
      const user=userAnswers[i]; const isDoubt=(user==="__DOUBT__");
      const ok=(q.kind==="halu"&&isDoubt)||(q.kind==="safe"&&user===q.answer);
      let statusHTML="";
      if(q.kind==="halu"){
        statusHTML=isDoubt
          ?`<div class="haluBanner ok">âœ… Anomalie correctement identifiÃ©e â€” +1 pt</div>`
          :`<div class="haluBanner">âŒ Contenu erronÃ© non dÃ©tectÃ© â€” 0 pt</div>`;
      } else {
        if(ok)         statusHTML=`<div style="color:var(--success);font-weight:600;margin-top:8px;font-size:0.88em;">âœ… RÃ©ponse correcte â€” +1 pt</div>`;
        else if(isDoubt) statusHTML=`<div style="color:var(--danger);font-weight:600;margin-top:8px;font-size:0.88em;">âŒ Signalement injustifiÃ© â€” 0 pt</div>`;
        else             statusHTML=`<div style="color:var(--danger);font-weight:600;margin-top:8px;font-size:0.88em;">âŒ RÃ©ponse incorrecte â€” 0 pt</div>`;
      }
      const div=document.createElement('div'); div.className="reviewItem";
      div.innerHTML=`
        <strong>Q${i+1} :</strong> ${q.q}<br>
        <span style="color:var(--muted);font-size:0.85em;">Votre rÃ©ponse :</span>
        <span class="answerTag ${ok?'ok':'bad'}">${isDoubt?"âš ï¸ Anomalie signalÃ©e":(user||"Temps Ã©coulÃ©")}</span><br>
        <span style="color:var(--muted);font-size:0.85em;">RÃ©ponse attendue :</span>
        ${q.kind==="halu"?"Information incorrecte (hallucination IA)":q.answer}<br>
        <div style="margin-top:6px;font-size:0.84em;color:var(--muted);font-style:italic;">${q.explanation}</div>
        ${statusHTML}
      `;
      reviewContainer.appendChild(div);
    });
  }

  // ---------- START ----------
  async function startGame(){
    if(!checkCooldown()){
      const next=getNextPlayTime(); const now=new Date(); const diff=next-now;
      const h=Math.floor(diff/3600000); const m=Math.floor((diff%3600000)/60000);
      quizDiv.innerHTML=`
        <div class="cooldownMessage">
          <h2>Session dÃ©jÃ  complÃ©tÃ©e</h2>
          <p>Vous avez dÃ©jÃ  rÃ©alisÃ© votre Ã©valuation aujourd'hui.<br>Prochaine session disponible Ã  <strong>minuit</strong> (dans ${h}h ${m}min).</p>
          <button onclick="location.reload()" style="margin-top:18px;padding:11px 26px;background:var(--accent);color:#fff;border:none;border-radius:10px;cursor:pointer;font-weight:700;font-family:var(--body-font);font-size:0.93em;">RafraÃ®chir</button>
        </div>`;
      return;
    }
    clearError(); resultDiv.classList.add('hidden'); quizDiv.classList.remove('hidden'); reviewContainer.innerHTML="";
    current=0; score=0; vigilance=0; userAnswers=new Array(10).fill(null); updateProgress();
    nextBtn.disabled=true; optionsContainer.innerHTML="";
    questionContainer.innerHTML=`<div class="question" style="color:var(--muted);font-weight:500;">GÃ©nÃ©ration de votre Ã©valuation en coursâ€¦</div>`;
    doubtBtn.classList.add("hidden"); doubtBtn.disabled=false;
    try{ await loadQuestions(); showQuestion(); }
    catch(e){ stopTimer(); timerDisplay.classList.add("hidden"); showError("Erreur de chargement : "+(e?.message||e)); questionContainer.innerHTML='<div class="question" style="color:var(--muted);">Impossible de charger l\'Ã©valuation.</div>'; nextBtn.disabled=true; }
  }

  startBtn.onclick=()=>{
    window.quizStartTime=Date.now();
    startScreen.classList.add("hidden");
    gameContainer.classList.remove("hidden");
    startGame();
  };

  // ---------- NOTIF POPUP ----------
  function showNotifPopup(){
    if(window.OneSignalDeferred){ OneSignalDeferred.push(async function(O){ try{ const sup=await O.Notifications.isPushSupported(); if(sup&&O.Notifications.permission!=="granted"){ document.getElementById('notifPopup').classList.remove('hidden'); } }catch(e){} }); }
  }
  window.showNotifPopup=showNotifPopup;

  document.addEventListener('DOMContentLoaded',()=>{
    const popup=document.getElementById('notifPopup');
    document.getElementById('notifAccept').onclick=async()=>{
      popup.classList.add('hidden');
      if(window.OneSignalDeferred){ OneSignalDeferred.push(async function(O){ try{ await O.Notifications.requestPermission(); await O.User.addTag("status","joueur_actif"); }catch(e){} }); }
    };
    document.getElementById('notifDecline').onclick=()=>popup.classList.add('hidden');
  });
</script>
</body>
</html>
